<!DOCTYPE html>
<html lang="ko">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>커뮤니티</title>
    <link rel="stylesheet" href="./css/style_search.css">
    <style>
        .caption-box {
            margin-bottom: 0.5rem;
        }
        
        .sort-options {
            display: flex;
            gap: 0.5rem;
            align-items: center;
            margin-bottom: 1rem;
            justify-content: flex-end;
        }
        
        .sort-options label {
            font-size: 1rem;
            color: #000;
            font-weight: 700;
            background-color: #fff;
            padding: 0.6rem 1rem;
            border: 2px solid #000;
            border-radius: 0;
            box-shadow: 3px 3px 0 #000;
        }
        
        .sort-options select {
            padding: 0.6rem 1.2rem;
            border: 2px solid #000;
            border-radius: 0;
            background-color: #fff;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 700;
            color: #000;
            box-shadow: 3px 3px 0 #000;
            outline: none;
        }
        
        .sort-options select:hover {
            background-color: #54C1FF;
            transform: translate(-2px, -2px);
            box-shadow: 5px 5px 0 #000;
        }
        
        .sort-options select:focus {
            background-color: #FFFFF0;
        }
        
        .sort-options select:active {
            transform: translate(2px, 2px);
            box-shadow: 1px 1px 0 #000;
        }
    </style>
</head>

<body>
    <!--header-->
    <div id="header"></div>

    <script type="module">
        fetch('components/header.html')
            .then(res => res.text())
            .then(html => {
                document.getElementById('header').innerHTML = html;
                const redirectURL = document.getElementById('redirect');
                redirectURL.textContent = window.location.href;
                const script = document.createElement('script');
                script.type = 'module';
                script.src = 'scripts/header_user.js';
                document.body.appendChild(script);
            });
    </script>
    <!--/header-->
    <main>
        <div class="caption-box">
            <h3 class="caption">[커뮤니티]게임을 찾고 유저들과 소통하세요.</h3>
        </div>
        <div class="sort-options">
            <label for="sortSelect">정렬:</label>
            <select id="sortSelect">
                <option value="default">기본순</option>
                <option value="rating">추천 많은 순</option>
                <option value="name">이름순</option>
            </select>
        </div>
         <section class="section">
            <div class="game-grid" id="gameGrid"></div>
            <template id="gameCardTpl">
                <article class="game-card">
                    <a class="link" href="#">
                        <img class="game-cover" src="" alt="">
                        <div class="game-meta">
                            <div class="game-title"></div>
                            <div class="badges"></div>
                            <div class="price"></div>
                            <div class="rate">
                                <div class="stars">
                                    <span class="star">★</span>
                                    <span class="star">★</span>
                                    <span class="star">★</span>
                                    <span class="star">★</span>
                                    <span class="star">★</span>
                                </div>
                            </div>
                        </div>
                    </a>
                </article>
            </template>
        </section>
        <script type="module">
            import supabase from './scripts/supabase.js';

            /*게임들 반환하는 함수*/
            async function loadGames(sortType = 'default') {
                let query = supabase.from('Games').select('*');
                
                // 정렬 조건 추가
                if (sortType === 'rating') {
                    query = query.order('avg_rating', { ascending: false, nullsFirst: false });
                } else if (sortType === 'name') {
                    query = query.order('title', { ascending: true });
                }
                
                const { data } = await query;
                return data;
            }

            /*별점 그려주는 함수*/
            function setRating(score, rateEl) {
                if (score != null) {
                    const stars = rateEl.querySelectorAll('.star');
                    stars.forEach((star, index) => {
                        star.classList.remove('full', 'half');
                        if (score >= index + 1) {
                            star.classList.add('full');
                        } else if (score >= index + 0.5) {
                            star.classList.add('half');
                        }
                    });
                }
                else {
                    console.log("평점이 NULL!!");
                }
            }

            /*데이터를 Card규격에 맞게 출력하고 정보 페이지로 연결하는 함수*/
            function renderGameData(games) {
                const grid = document.getElementById('gameGrid');
                const tpl = document.getElementById('gameCardTpl');
                grid.innerHTML = '';
                for (const g of games) {
                    const node = tpl.content.firstElementChild.cloneNode(true);

                    node.querySelector('.link').href = 
                    `/board.html?game_id=${g.game_id}&slug=${g.slug}&title=${g.title}`;
                    const img = node.querySelector('.game-cover');
                    img.src = g.cover_image_url || '1.jpg';
                    img.alt = `${g.title} 커버`;

                    node.querySelector('.game-title').textContent = g.title;

                    const badges = node.querySelector('.badges');
                    badges.innerHTML = '';
                    const badge = document.createElement('span');
                    badge.className = 'badge';
                    badge.textContent = g.genre || '장르';
                    badges.appendChild(badge);

                    const priceBox = node.querySelector('.price');
                    priceBox.innerHTML = `<span>${g.developer || '개발사 정보 없음'}</span>`;
        
                    setRating(g.avg_rating, node.querySelector('.rate'))

                    grid.appendChild(node);
                }
            }

            /*게임들 출력하는 함수*/
            async function renderGames(sortType = 'default') {
                const data = await loadGames(sortType);
                if (data && data.length > 0) {
                    renderGameData(data)
                }
            }

            /*정렬 옵션 변경 이벤트*/
            document.getElementById('sortSelect').addEventListener('change', (e) => {
                renderGames(e.target.value);
            });

            /*최종 출력*/
            renderGames();
        </script>
    </main>

</body>

</html>