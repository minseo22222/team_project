<!-- public/index.html -->
<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Steam ê²Œì„ ê²€ìƒ‰ Â· ë“±ë¡ ë„êµ¬</title>
  <style>
    /* Pop Art í…Œë§ˆ */
    :root {
      --bg-color: #FFFFFF;
      --card-bg: #FFFFFF;
      --ink: #000000;
      --brand: #54C1FF;
      --accent-pink: #FF90E8;
      --accent-green: #00E054;
      --border-w: 3px;
      --shadow-hard: 4px 4px 0px 0px #000000;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: 'Pretendard', -apple-system, system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: var(--bg-color);
      color: var(--ink);
    }

    h1 {
      font-size: 28px;
      font-weight: 900;
      margin: 0 0 20px;
      text-transform: uppercase;
      background: var(--brand);
      border: var(--border-w) solid #000;
      box-shadow: var(--shadow-hard);
      padding: 15px;
      text-align: center;
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
    }

    .card {
      border: var(--border-w) solid #000;
      background: var(--card-bg);
      padding: 20px;
      margin: 20px 0;
      box-shadow: var(--shadow-hard);
    }

    input {
      padding: 10px 14px;
      font-size: 15px;
      font-weight: 600;
      border: 2px solid #000;
      background: #fff;
      outline: none;
      box-shadow: 2px 2px 0 #eee;
      transition: all 0.1s;
    }

    input:focus {
      background: #fffff0;
      transform: translate(-1px, -1px);
      box-shadow: 3px 3px 0 #000;
    }

    button {
      padding: 10px 20px;
      font-size: 15px;
      font-weight: 800;
      border: 2px solid #000;
      background: var(--accent-green);
      cursor: pointer;
      box-shadow: var(--shadow-hard);
      transition: all 0.1s;
      text-transform: uppercase;
    }

    button:hover {
      transform: translate(-2px, -2px);
      box-shadow: 6px 6px 0 #000;
    }

    button:active {
      transform: translate(2px, 2px);
      box-shadow: 2px 2px 0 #000;
    }

    img.cover {
      max-width: 100%;
      border: 2px solid #000;
      box-shadow: var(--shadow-hard);
      margin: 10px 0;
    }

    img.thumb {
      width: 72px;
      height: 72px;
      object-fit: cover;
      border: 2px solid #000;
      box-shadow: 2px 2px 0 #000;
    }

    .grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 15px;
      margin-top: 15px;
    }

    .pill {
      display: inline-block;
      padding: 4px 10px;
      border: 2px solid #000;
      background: var(--accent-pink);
      margin: 3px;
      font-size: 13px;
      font-weight: 700;
      box-shadow: 2px 2px 0 #000;
    }

    .muted {
      color: #666;
      font-weight: 600;
    }

    pre {
      background: #000;
      color: #0f0;
      padding: 15px;
      overflow: auto;
      border: 2px solid #000;
      font-size: 13px;
      box-shadow: var(--shadow-hard);
    }

    a.result {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      text-decoration: none;
      color: inherit;
      border: 2px solid #000;
      background: #fff;
      margin: 8px 0;
      box-shadow: 3px 3px 0 #000;
      transition: all 0.1s;
      font-weight: 600;
    }

    a.result:hover {
      background: var(--brand);
      transform: translate(-2px, -2px);
      box-shadow: 5px 5px 0 #000;
    }

    #regResult {
      margin-top: 15px;
      padding: 15px;
      background: var(--accent-green);
      border: 2px solid #000;
      box-shadow: var(--shadow-hard);
    }

    details {
      margin-top: 15px;
      border: 2px solid #000;
      padding: 10px;
      background: #fff;
      box-shadow: 3px 3px 0 #000;
    }

    summary {
      font-weight: 800;
      cursor: pointer;
      padding: 5px;
      background: var(--brand);
      border: 2px solid #000;
      margin: -10px -10px 10px;
      box-shadow: 2px 2px 0 #000;
    }

    table {
      width: 100%;
      margin-top: 10px;
      border-collapse: collapse;
    }

    th, td {
      text-align: left;
      padding: 8px;
      border: 2px solid #000;
      font-weight: 700;
    }

    th {
      background: var(--accent-pink);
    }

    @media (max-width: 768px) {
      body { padding: 10px; }
      .row { flex-direction: column; }
      input { width: 100%; }
    }
  </style>
</head>
<body>
  <h1>ğŸ® Steam ê²Œì„ ê²€ìƒ‰ Â· ë“±ë¡</h1>

  <!-- ê²€ìƒ‰ -->
  <div class="card">
    <div class="row">
      <input id="q" style="min-width:260px" placeholder="ê²Œì„ëª… ì…ë ¥ (ì˜ˆ: ì—˜ë“ ë§, æ³•ç¯)" />
      <button id="btnSearch">ê²€ìƒ‰</button>
    </div>
    <div id="searchOut" style="margin-top:15px"><small class="muted">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</small></div>
  </div>

  <!-- ì•± ìƒì„¸ + ë“±ë¡ -->
  <div class="card">
    <div class="row">
      <input id="appInput" style="min-width:160px" placeholder="AppID (ì˜ˆ: 1245620)" />
      <button id="btnApp">ì•± ì¡°íšŒ</button>
      <button id="btnRegister" style="background: var(--accent-pink);">DB ë“±ë¡</button>
      <button id="btnReq" style="background: var(--brand);">ì‚¬ì–‘ ë³´ê¸°</button>
    </div>

    <div id="regResult" style="display:none;"></div>
    <div id="appOut" style="margin-top:15px"><small class="muted">ì•± ì •ë³´ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</small></div>
    <div id="reqOut" style="margin-top:15px"></div>
  </div>

  <script type="module">
    const API_BASE = location.port === "3000" ? "" : "http://localhost:3000";
    const $ = (id) => document.getElementById(id);
    const escapeHtml = (s) => String(s||'').replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
    const money = (cents) => (cents==null ? 'â€”' : (cents/100).toLocaleString("ko-KR"));

    // ê²€ìƒ‰
    async function doSearch(){
      const q = $('q').value.trim();
      const out = $('searchOut');
      if(!q){ out.innerHTML = '<small class="muted">ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>'; return; }
      out.innerHTML = '<small class="muted">ê²€ìƒ‰ ì¤‘...</small>';
      try{
        const r = await fetch(`${API_BASE}/api/search?term=${encodeURIComponent(q)}`);
        const body = await r.json();
        if(!r.ok) throw new Error(body.error || 'ê²€ìƒ‰ ì‹¤íŒ¨');
        if(!Array.isArray(body.items) || !body.items.length){
          out.innerHTML = '<small class="muted">ê²°ê³¼ ì—†ìŒ</small>'; return;
        }
        out.innerHTML = body.items.map(it => `
          <a class="result" href="javascript:void(0)" data-appid="${it.appid}">
            ${it.tiny_image ? `<img class="thumb" src="${it.tiny_image}" alt="">` : ''}
            <div><strong>${escapeHtml(it.name)}</strong> <span class="muted">(${it.appid})</span></div>
          </a>
        `).join('');
        out.querySelectorAll('a.result').forEach(a => {
          a.addEventListener('click', () => {
            $('appInput').value = a.dataset.appid;
            loadApp();
            $('appOut').scrollIntoView({ behavior:'smooth', block:'start' });
          });
        });
      }catch(e){
        out.innerHTML = `<pre>${escapeHtml(e.message)}</pre>`;
      }
    }

    // ì•± ìƒì„¸
    async function loadApp(){
      const out = $('appOut');
      const id = $('appInput').value.trim();
      if(!/^\d+$/.test(id)){ out.innerHTML = '<small class="muted">AppIDë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>'; return; }
      out.innerHTML = '<small class="muted">ë¡œë”© ì¤‘...</small>';
      try{
        const r = await fetch(`${API_BASE}/api/app/${id}`);
        const body = await r.json();
        if(!r.ok) throw new Error(body.error || 'ì¡°íšŒ ì‹¤íŒ¨');

        const pills = (arr=[]) => arr.map(x => `<span class="pill">${escapeHtml(x)}</span>`).join(' ');
        const shots = (body.screenshots || []).slice(0, 12)
          .map(s => `<img class="thumb" src="${s.thumb}" alt="">`).join('');

        out.innerHTML = `
          ${body.header_image ? `<img class="cover" src="${body.header_image}" alt="">` : ''}
          <p style="font-size:20px; font-weight:900; margin:10px 0;"><strong>${escapeHtml(body.name || '')}</strong> <span class="muted">(${escapeHtml(body.type || '-')})</span></p>
          <p><strong>ë¬´ë£Œ:</strong> ${body.is_free ? 'ì˜ˆ' : 'ì•„ë‹ˆì˜¤'} Â· <strong>ê°€ê²©:</strong> â‚©${money(body.price_cents)}</p>
          <p><strong>ì¥ë¥´:</strong> ${pills(body.genres)}</p>
          <p><strong>ê°œë°œì‚¬:</strong> ${escapeHtml(body.developers || '-')}</p>
          <p><strong>ìœ í†µì‚¬:</strong> ${escapeHtml(body.publishers || '-')}</p>
          <div class="grid">${shots || '<small class="muted">ìŠ¤í¬ë¦°ìƒ· ì—†ìŒ</small>'}</div>
          <details><summary>ì›ë³¸ JSON</summary><pre>${escapeHtml(JSON.stringify(body, null, 2))}</pre></details>
        `;
      }catch(e){
        out.innerHTML = `<pre>${escapeHtml(e.message)}</pre>`;
      }
    }

    // DB ë“±ë¡
    async function registerApp() {
      const id = $('appInput').value.trim();
      const resBox = $('regResult');
      
      if (!/^\d+$/.test(id)) return alert('AppIDë¥¼ ì…ë ¥í•˜ì„¸ìš”');

      resBox.style.display = 'block';
      resBox.innerHTML = '<small class="muted">ë“±ë¡ ë° ì ìˆ˜ ê³„ì‚° ì¤‘...</small>';

      try {
        const r = await fetch(`${API_BASE}/api/register`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ appid: id })
        });
        
        const j = await r.json();
        if (!r.ok) throw new Error(j.error || 'ë“±ë¡ ì‹¤íŒ¨');

        const scores = j.scores || {};
        const saved = j.saved || {};

        const renderScores = (scoreObj) => {
          if (!scoreObj || Object.keys(scoreObj).length === 0) return '<span style="color:#666">0 (ë¯¸ì‹ë³„)</span>';
          return Object.entries(scoreObj).map(([name, score]) => 
            `<div style="font-size:13px; margin:2px 0;"><span style="color:#000;">${escapeHtml(name)}:</span> <b>${score.toLocaleString()}</b></div>`
          ).join('');
        };

        resBox.innerHTML = `
          <div style="border-left:4px solid #000; padding-left:15px;">
            <h3 style="margin:0 0 10px; font-size:18px;">âœ… ë“±ë¡ ì„±ê³µ!</h3>
            <p style="font-weight:900; font-size:16px;">${escapeHtml(saved.title)}</p>
            <div style="margin-top:12px; background:#fff; padding:12px; border:2px solid #000; box-shadow: 3px 3px 0 #000;">
              <strong style="font-size:16px;">ğŸ“Š ë²¤ì¹˜ë§ˆí¬ ì ìˆ˜</strong>
              <table style="margin-top:8px;">
                <tr>
                  <th>êµ¬ë¶„</th>
                  <th>ìµœì†Œ</th>
                  <th>ê¶Œì¥</th>
                </tr>
                <tr>
                  <td><b>CPU</b></td>
                  <td>${renderScores(scores.min_cpu_score)}</td>
                  <td>${renderScores(scores.rec_cpu_score)}</td>
                </tr>
                <tr>
                  <td><b>GPU</b></td>
                  <td>${renderScores(scores.min_gpu_score)}</td>
                  <td>${renderScores(scores.rec_gpu_score)}</td>
                </tr>
              </table>
            </div>
          </div>
        `;

      } catch (e) {
        resBox.innerHTML = `<div style="color:red; font-weight:bold;">âŒ ì˜¤ë¥˜: ${escapeHtml(e.message)}</div>`;
      }
    }

    // ìš”êµ¬ ì‚¬ì–‘
    async function loadReq(){
      const out = $('reqOut');
      const id = $('appInput').value.trim();
      if(!/^\d+$/.test(id)){ out.innerHTML = '<small class="muted">AppIDë¥¼ ì…ë ¥í•˜ì„¸ìš”</small>'; return; }
      out.innerHTML = '<small class="muted">ë¡œë”© ì¤‘...</small>';
      try{
        const r = await fetch(`${API_BASE}/api/app/${id}/requirements`);
        const b = await r.json();
        if(!r.ok) throw new Error(b.error || 'ì¡°íšŒ ì‹¤íŒ¨');
        const pc = b.pc_requirements || {};
        out.innerHTML = `
          <div style="background:#fff; padding:15px; border:2px solid #000; box-shadow: var(--shadow-hard);">
            <h3 style="background: var(--brand); padding:8px; border:2px solid #000; margin:-15px -15px 15px;">ìµœì†Œ ì‚¬ì–‘</h3>
            <div>${pc.minimum_html || 'â€”'}</div>
            <h3 style="background: var(--accent-pink); padding:8px; border:2px solid #000; margin:15px -15px 15px;">ê¶Œì¥ ì‚¬ì–‘</h3>
            <div>${pc.recommended_html || 'â€”'}</div>
          </div>
          <details><summary>êµ¬ì¡°í™” ë°ì´í„°</summary><pre>${escapeHtml(JSON.stringify(pc, null, 2))}</pre></details>
        `;
      }catch(e){
        out.innerHTML = `<pre>${escapeHtml(e.message)}</pre>`;
      }
    }

    // ì´ë²¤íŠ¸
    $('btnSearch').addEventListener('click', doSearch);
    $('q').addEventListener('keydown', e => { if(e.key==='Enter') doSearch(); });
    $('btnApp').addEventListener('click', loadApp);
    $('appInput').addEventListener('keydown', e => { if(e.key==='Enter') loadApp(); });
    $('btnRegister').addEventListener('click', registerApp);
    $('btnReq').addEventListener('click', loadReq);
  </script>
</body>
</html>