<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²Œì„ ìƒì„¸ - ê°“ê²œíŒë…ê¸°</title>
  <link rel="stylesheet" href="./css/style_game.css">
  <link rel="stylesheet" href="./css/style_review.css">
</head>

<body>
  <div id="header"></div>

  <script type="module">
    // [ì¶”ê°€ëœ ë¶€ë¶„ 1] Supabase ê°€ì ¸ì˜¤ê¸°
    import supabase from './scripts/supabase.js';

    // [ì¶”ê°€ëœ ë¶€ë¶„ 2] ë¡œê·¸ì•„ì›ƒ ê°ì§€ ë¦¬ìŠ¤ë„ˆ
    // í—¤ë”ì—ì„œ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ ì½”ë“œê°€ ê°ì§€í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT') {
        window.location.reload();
      }
    });

    // ê¸°ì¡´ í—¤ë” ë¡œë“œ ë¡œì§
    fetch('components/header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('header').innerHTML = html;
        const redirectURL = document.getElementById('redirect');
        if (redirectURL) { // ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ if ì²´í¬ ì¶”ê°€
            redirectURL.textContent = window.location.href; 
        }
        
        // ì™¸ë¶€ JS ì¶”ê°€ ì‹¤í–‰
        const script = document.createElement('script');
        script.type = 'module';
        script.src = 'scripts/header_user.js';
        document.body.appendChild(script);
      });
  </script>
  <main>
    <div class="loading" id="loading">
      ê²Œì„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>

    <div id="gameContent" style="display: none;"></div>

    <div class="error" id="error" style="display: none;">
      <h2>âš ï¸ ê²Œì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
      <p>ìš”ì²­í•˜ì‹  ê²Œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <a href="/home.html">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  
  <!--/main-->
  
  <script type="module" src="./scripts/game.js"></script>

  <section class="spec-check-section">
    <h2>ğŸ–¥ï¸ ë‚´ ì»´í“¨í„°ë¡œ ì‹¤í–‰ ê°€ëŠ¥í• ê¹Œ?</h2>
    
    <div class="spec-container">
      <div class="spec-item">
        <h3>1. CPU (í”„ë¡œì„¸ì„œ)</h3>
        <div class="search-box">
          <input type="text" id="cpuInput" placeholder="ì˜ˆ: 5600x, i5-12400">
          <button onclick="searchPart('cpu')" class="spec-btn">ê²€ìƒ‰</button>
        </div>
        <div id="cpuList" class="result-list"></div>
        <div id="cpuSelectedText" class="selected-text">ì„ íƒëœ ë¶€í’ˆ ì—†ìŒ</div>
        <input type="hidden" id="myCpuScore" value="0">
      </div>

      <div class="spec-item">
        <h3>2. GPU (ê·¸ë˜í”½ì¹´ë“œ)</h3>
        <div class="search-box">
          <input type="text" id="gpuInput" placeholder="ì˜ˆ: RTX 3060, GTX 1060">
          <button onclick="searchPart('gpu')" class="spec-btn">ê²€ìƒ‰</button>
        </div>
        <div id="gpuList" class="result-list"></div>
        <div id="gpuSelectedText" class="selected-text">ì„ íƒëœ ë¶€í’ˆ ì—†ìŒ</div>
        <input type="hidden" id="myGpuScore" value="0">
      </div>
    </div>

    <div class="spec-result-container">
      <h3>3. êµ¬ë™ ì—¬ë¶€ í™•ì¸</h3>
      <button onclick="checkCanRun()" class="check-btn">ğŸ® ì‹¤í–‰ ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ê¸°</button>
      <div id="finalResult" class="final-result">
        ë¶€í’ˆì„ ì„ íƒí•˜ê³  ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.
      </div>
    </div>
  </section>
  
  <script type="module">
  // supabase import ì¶”ê°€
  import supabase from './scripts/supabase.js';

  // ë¶€í’ˆ ê²€ìƒ‰ í•¨ìˆ˜
  async function searchPart(type) {
    const inputId = type + 'Input';
    const listId = type + 'List';
    const tableName = type + '_tb';

    const keyword = document.getElementById(inputId).value;
    const listDiv = document.getElementById(listId);

    if(!keyword) { 
      alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!"); 
      return; 
    }

    listDiv.style.display = 'block';
    listDiv.innerHTML = '<div class="result-item">ê²€ìƒ‰ ì¤‘...</div>';

    try {
      const { data, error } = await supabase
        .from(tableName)
        .select('*')
        .ilike('model_name', '%' + keyword + '%')
        .order('score', { ascending: false })
        .limit(10);

      if (error) {
        console.error("Supabase Error:", error);
        listDiv.innerHTML = '<div class="result-item">ì˜¤ë¥˜: ' + error.message + '</div>';
        return;
      }

      listDiv.innerHTML = '';

      if (!data || data.length === 0) {
        listDiv.innerHTML = '<div class="result-item">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `<strong>${item.model_name}</strong><br><span style="font-size:0.85em; color:#64748b;">ì ìˆ˜: ${item.score}</span>`;
        
        div.onclick = function() {
          selectPart(type, item.model_name, item.score);
        };
        listDiv.appendChild(div);
      });
    } catch (err) {
      console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', err);
      listDiv.innerHTML = '<div class="result-item">ê²€ìƒ‰ ì‹¤íŒ¨: ' + err.message + '</div>';
    }
  }

  // ë¶€í’ˆ ì„ íƒ í•¨ìˆ˜
  function selectPart(type, name, score) {
    document.getElementById(type + 'SelectedText').innerText = `âœ… ì„ íƒë¨: ${name}`;
    document.getElementById('my' + type.charAt(0).toUpperCase() + type.slice(1) + 'Score').value = score;
    document.getElementById(type + 'List').style.display = 'none';
  }

  // ìµœì¢… ë¹„êµ í•¨ìˆ˜
  async function checkCanRun() {
    const myCpuScore = parseInt(document.getElementById('myCpuScore').value);
    const myGpuScore = parseInt(document.getElementById('myGpuScore').value);
    const resultDiv = document.getElementById('finalResult');

    const params = new URLSearchParams(window.location.search);
    const gameSlug = params.get('id');

    if (myCpuScore === 0 || myGpuScore === 0) {
      alert("ë¨¼ì € CPUì™€ ê·¸ë˜í”½ì¹´ë“œë¥¼ ê²€ìƒ‰í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”!");
      return;
    }

    resultDiv.innerHTML = "ê²Œì„ ë°ì´í„° ë¶„ì„ ì¤‘...";

    try {
      const { data: gameData, error: gameError } = await supabase
        .from('Games')
        .select('steam_app_id')
        .eq('slug', gameSlug)
        .single();

      if (gameError || !gameData?.steam_app_id) {
        resultDiv.innerHTML = "<span class='spec-fail'>ê²Œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>";
        return;
      }

      const { data, error } = await supabase
        .from('game_score_tb')
        .select('*')
        .eq('steam_app_id', gameData.steam_app_id)
        .single();

      if (error || !data) {
        console.error(error);
        resultDiv.innerHTML = "<span class='spec-fail'>ì´ ê²Œì„ì˜ ì‚¬ì–‘ ë°ì´í„°ê°€ ì•„ì§ ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span>";
        return;
      }

      let cpuStatus = (myCpuScore >= data.min_cpu_score) ? 
                      `<span class="spec-pass">í•©ê²©</span>` : `<span class="spec-fail">ë¶ˆí•©ê²©</span>`;
      
      let gpuStatus = (myGpuScore >= data.min_gpu_score) ? 
                      `<span class="spec-pass">í•©ê²©</span>` : `<span class="spec-fail">ë¶ˆí•©ê²©</span>`;

      let finalVerdict = "";
      if (myCpuScore >= data.min_cpu_score && myGpuScore >= data.min_gpu_score) {
        finalVerdict = `<h3 class="spec-pass" style="margin-top:15px;">ğŸ‰ í”Œë ˆì´ ê°€ëŠ¥! (ìµœì†Œì‚¬ì–‘ ì¶©ì¡±)</h3>`;
      } else {
        finalVerdict = `<h3 class="spec-fail" style="margin-top:15px;">ğŸ˜¢ êµ¬ë™ ë¶ˆê°€ (ì‚¬ì–‘ ë¶€ì¡±)</h3>`;
      }

      resultDiv.innerHTML = `
        <h4>[ ë¶„ì„ ê²°ê³¼ ]</h4>
        <p><strong>CPU:</strong> ${cpuStatus} (ë‚´ ì ìˆ˜: ${myCpuScore} / í•„ìš”: ${data.min_cpu_score})</p>
        <p><strong>GPU:</strong> ${gpuStatus} (ë‚´ ì ìˆ˜: ${myGpuScore} / í•„ìš”: ${data.min_gpu_score})</p>
        ${finalVerdict}
      `;
    } catch (err) {
      console.error('í™•ì¸ ì˜¤ë¥˜:', err);
      resultDiv.innerHTML = "<span class='spec-fail'>ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + err.message + "</span>";
    }
  }

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (HTML onclickì—ì„œ ì‚¬ìš©)
  window.searchPart = searchPart;
  window.checkCanRun = checkCanRun;
</script>

  <section class="reviews-section" id="reviews">
    <h2>í‰ê°€ ì‘ì„±</h2>

    <form class="review-composer" action="" method="post">
      <div class="row">
        <strong>ë³„ì :</strong>
        <div class="rating" aria-label="ë³„ì  ì„ íƒ">
          <input type="radio" id="star5" name="rating" value="5" >
          <label for="star5" title="5ì "></label>

          <input type="radio" id="star4" name="rating" value="4">
          <label for="star4" title="4ì "></label>

          <input type="radio" id="star3" name="rating" value="3">
          <label for="star3" title="3ì "></label>

          <input type="radio" id="star2" name="rating" value="2">
          <label for="star2" title="2ì "></label>

          <input type="radio" id="star1" name="rating" value="1">
          <label for="star1" title="1ì "></label>
        </div>
      </div>
      <div class="row recommend-row">
        <strong></strong>
        <div class="recommend" role="radiogroup" aria-label="ì¶”ì²œ ì—¬ë¶€">
          <input type="radio" id="rec-yes" name="is_recommended" value="1" >
          <label for="rec-yes" class="chip yes">ì¶”ì²œ</label>

          <input type="radio" id="rec-no" name="is_recommended" value="0">
          <label for="rec-no" class="chip no">ë¹„ì¶”ì²œ</label>
        </div>
      </div>

      <textarea name="comment" placeholder="ê²Œì„ì— ëŒ€í•œ í‰ê°€ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>

      <div class="review-actions">
        <input type="reset" value="ë‹¤ì‹œì“°ê¸°" class="btn">
        <input type="submit" value="í‰ê°€" class="btn">
      </div>
    </form>
  </section>

  <section class="reviews-view" id="reviews-view">
    <div class="reviews-toolbar">
      <button type="button" class="sort-btn active" data-sort="time">ì‹œê°„ìˆœ â–¾</button>
      <button type="button" class="sort-btn" data-sort="reco">ì¶”ì²œìˆœ â–¾</button>
    </div>

    <div id="review-list" class="review-list" aria-live="polite"></div>

  <button id="load-more" class="loadmore-btn" type="button">ì¶”ê°€ ë³´ê¸°</button>
</section>
</main>
<script type="module" src="./scripts/review.js"></script>
</body>
</html>