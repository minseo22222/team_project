<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ê²Œì‹œê¸€ - ê°“ê²œíŒë…ê¸°</title>
  <link rel="stylesheet" href="./css/style_game.css">
  <!-- Quill.js CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/style_board_post.css">
</head>
<body>
  <div id="header"></div>

  <main class="post-container">
    <!-- ë¡œë”© -->
    <div class="loading" id="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <!-- ì—ëŸ¬ -->
    <div class="error" id="error" style="display: none;">
      <h2>âš ï¸ ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
      <p>ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œê¸€ì…ë‹ˆë‹¤.</p>
      <button class="back-btn" onclick="history.back()">â† ëŒì•„ê°€ê¸°</button>
    </div>

    <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
    <div id="postContent" style="display: none;">
      <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
      <div class="game-nav-buttons">
        <button class="nav-btn" id="gameNavBtn">
          â­ í‰ê°€
        </button>
        <button class="nav-btn active">
          ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°
        </button>
      </div>

      <div class="post-header">
        <div class="breadcrumb">
          <a href="/home.html">í™ˆ</a> > 
          <a href="#" id="gameLink">ê²Œì„</a> > 
          <a href="#" id="boardLink">ê²Œì‹œíŒ</a> > 
          ê²Œì‹œê¸€
        </div>
        <h1 class="post-title" id="postTitle"></h1>
        <div class="post-meta">
          <div class="post-meta-left">
            <div class="author-info">
              <img class="author-avatar" id="authorAvatar" src="" alt="í”„ë¡œí•„">
              <span id="authorName"></span>
            </div>
            <span id="postDate"></span>
            <span>ğŸ‘ï¸ <span id="postViews"></span></span>
          </div>
          <div class="edit-delete-section" id="ownerActions" style="display: none;">
            <button class="edit-btn" onclick="editPost()">ìˆ˜ì •</button>
            <button class="delete-btn" onclick="deletePost()">ì‚­ì œ</button>
          </div>
        </div>
      </div>

      <!-- ê²Œì‹œê¸€ ë³¸ë¬¸ -->
      <div class="post-content-box" id="postContentText"></div>

      <!-- ìˆ˜ì • í¼ (ìˆ¨ê¹€ ìƒíƒœ) -->
      <div class="edit-form" id="editForm" style="display: none;">
        <div class="form-group">
          <label>ì œëª©</label>
          <input type="text" id="editTitle" maxlength="200">
        </div>
        <div class="form-group">
          <label>ë‚´ìš©</label>
          <div id="editEditor"></div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="cancelEdit()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" onclick="saveEdit()">ì €ì¥</button>
        </div>
      </div>

      <div class="post-actions">
        <div class="like-dislike-section">
          <button class="like-btn" id="likeBtn" onclick="toggleLike()">
            ğŸ‘ ì¢‹ì•„ìš” <span id="likeCount">0</span>
          </button>
          <button class="dislike-btn" id="dislikeBtn" onclick="toggleDislike()">
            ğŸ‘ ì‹«ì–´ìš” <span id="dislikeCount">0</span>
          </button>
        </div>
        <div class="bottom-actions">
          <button class="back-btn" onclick="goBackToBoard()">â† ëª©ë¡ìœ¼ë¡œ</button>
        </div>
      </div>
    </div>
  </main>

  <!-- Quill.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>

  <script type="module">
    import supabase from './scripts/supabase.js';

    let editQuill = null;

    // í—¤ë” ë¡œë“œ
    fetch('components/header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('header').innerHTML = html;
        const redirectURL = document.getElementById('redirect');
        redirectURL.textContent = window.location.href;
        const script = document.createElement('script');
        script.type = 'module';
        script.src = 'scripts/header_user.js';
        document.body.appendChild(script);
      });

    // URL íŒŒë¼ë¯¸í„°
    const params = new URLSearchParams(window.location.search);
    const postId = params.get('id');

    let currentUser = null;
    let currentPost = null;

    if (!postId) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
    } else {
      loadPost();
    }

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    async function checkAuthStatus() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      
      // ë³¸ì¸ ê²Œì‹œê¸€ì´ë©´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
      if (user && currentPost && user.id === currentPost.user_id) {
        document.getElementById('ownerActions').style.display = 'flex';
      }
    }

    // ê²Œì‹œê¸€ ë¡œë“œ
    async function loadPost() {
      try {
        // ì¡°íšŒìˆ˜ ì¦ê°€
        await supabase.rpc('increment_post_views', { post_id: postId });

        // ê²Œì‹œê¸€ ì¡°íšŒ
        const { data, error } = await supabase
          .from('board_posts')
          .select(`
            *,
            Users!board_posts_user_id_fkey (
              nickname,
              profile_image_url
            )
          `)
          .eq('post_id', postId)
          .single();

        if (error || !data) throw new Error('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');

        currentPost = data;
        const author = data.Users || {};

        // í˜ì´ì§€ íƒ€ì´í‹€
        document.title = `${data.title} - ê°“ê²œíŒë…ê¸°`;

        // ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ ì„¤ì •
        document.getElementById('gameLink').textContent = data.game_title || 'ê²Œì„';
        document.getElementById('gameLink').href = `/game.html?id=${data.game_slug}`;
        document.getElementById('boardLink').href = `/board.html?game_id=${data.game_id}&slug=${data.game_slug}&title=${encodeURIComponent(data.game_title || '')}`;
        document.getElementById('gameNavBtn').onclick = () => {
          window.location.href = `/game.html?id=${data.game_slug}`;
        };

        // ê²Œì‹œê¸€ ë‚´ìš©
        document.getElementById('postTitle').textContent = data.title;
        document.getElementById('authorAvatar').src = author.profile_image_url || '';
        document.getElementById('authorName').textContent = author.nickname || 'ìµëª…';
        document.getElementById('postDate').textContent = new Date(data.created_at).toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('postViews').textContent = data.views || 0;
        document.getElementById('postContentText').innerHTML = data.content;
        document.getElementById('likeCount').textContent = data.like_count || 0;
        document.getElementById('dislikeCount').textContent = data.dislike_count || 0;

        // í™”ë©´ í‘œì‹œ
        document.getElementById('loading').style.display = 'none';
        document.getElementById('postContent').style.display = 'block';

        // ë¡œê·¸ì¸ í™•ì¸
        await checkAuthStatus();

      } catch (err) {
        console.error('Error loading post:', err);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }

    // ê²Œì‹œíŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
    window.goBackToBoard = function() {
      if (currentPost) {
        window.location.href = `/board.html?game_id=${currentPost.game_id}&slug=${currentPost.game_slug}&title=${encodeURIComponent(currentPost.game_title || '')}`;
      } else {
        history.back();
      }
    };

    // ì¢‹ì•„ìš”
    window.toggleLike = async function() {
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      try {
        const likeBtn = document.getElementById('likeBtn');
        const isLiked = likeBtn.classList.contains('active');

        if (isLiked) {
          const newCount = Math.max(0, (currentPost.like_count || 0) - 1);
          const { error } = await supabase
            .from('board_posts')
            .update({ like_count: newCount })
            .eq('post_id', postId);

          if (error) throw error;

          currentPost.like_count = newCount;
          document.getElementById('likeCount').textContent = newCount;
          likeBtn.classList.remove('active');
        } else {
          const newCount = (currentPost.like_count || 0) + 1;
          const { error } = await supabase
            .from('board_posts')
            .update({ like_count: newCount })
            .eq('post_id', postId);

          if (error) throw error;

          currentPost.like_count = newCount;
          document.getElementById('likeCount').textContent = newCount;
          likeBtn.classList.add('active');
        }
      } catch (err) {
        console.error('Error:', err);
        alert('ì¢‹ì•„ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ì‹«ì–´ìš”
    window.toggleDislike = async function() {
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      try {
        const dislikeBtn = document.getElementById('dislikeBtn');
        const isDisliked = dislikeBtn.classList.contains('active');

        if (isDisliked) {
          const newCount = Math.max(0, (currentPost.dislike_count || 0) - 1);
          const { error } = await supabase
            .from('board_posts')
            .update({ dislike_count: newCount })
            .eq('post_id', postId);

          if (error) throw error;

          currentPost.dislike_count = newCount;
          document.getElementById('dislikeCount').textContent = newCount;
          dislikeBtn.classList.remove('active');
        } else {
          const newCount = (currentPost.dislike_count || 0) + 1;
          const { error } = await supabase
            .from('board_posts')
            .update({ dislike_count: newCount })
            .eq('post_id', postId);

          if (error) throw error;

          currentPost.dislike_count = newCount;
          document.getElementById('dislikeCount').textContent = newCount;
          dislikeBtn.classList.add('active');
        }
      } catch (err) {
        console.error('Error:', err);
        alert('ì‹«ì–´ìš” ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ìˆ˜ì • ëª¨ë“œ ì§„ì…
    window.editPost = function() {
      // ë³¸ë¬¸ ìˆ¨ê¸°ê³  ìˆ˜ì • í¼ í‘œì‹œ
      document.getElementById('postContentText').style.display = 'none';
      document.getElementById('editForm').style.display = 'block';

      // ì œëª© ì…ë ¥
      document.getElementById('editTitle').value = currentPost.title;

      // Quill ì—ë””í„° ì´ˆê¸°í™”
      if (!editQuill) {
        editQuill = new Quill('#editEditor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              [{ 'size': ['small', false, 'large', 'huge'] }],
              ['bold', 'italic', 'underline', 'strike'],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              ['link'],
              ['clean']
            ]
          }
        });
      }
      
      // ê¸°ì¡´ ë‚´ìš© ë¡œë“œ
      editQuill.root.innerHTML = currentPost.content;
    };

    // ìˆ˜ì • ì·¨ì†Œ
    window.cancelEdit = function() {
      document.getElementById('postContentText').style.display = 'block';
      document.getElementById('editForm').style.display = 'none';
    };

    // ìˆ˜ì • ì €ì¥
    window.saveEdit = async function() {
      const newTitle = document.getElementById('editTitle').value.trim();
      const newContent = editQuill.root.innerHTML.trim();
      const textContent = editQuill.getText().trim();

      if (!newTitle || !textContent) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const { error } = await supabase
          .from('board_posts')
          .update({
            title: newTitle,
            content: newContent,
            updated_at: new Date().toISOString()
          })
          .eq('post_id', postId);

        if (error) throw error;

        alert('ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        // ê²Œì‹œê¸€ ë‹¤ì‹œ ë¡œë“œ
        currentPost.title = newTitle;
        currentPost.content = newContent;
        document.getElementById('postTitle').textContent = newTitle;
        document.getElementById('postContentText').innerHTML = newContent;
        
        cancelEdit();
      } catch (err) {
        console.error('Error:', err);
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ì‚­ì œ
    window.deletePost = async function() {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const { error } = await supabase
          .from('board_posts')
          .delete()
          .eq('post_id', postId);

        if (error) throw error;

        alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        goBackToBoard();
      } catch (err) {
        console.error('Error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };
  </script>
</body>
</html>