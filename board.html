<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>게시판 - 갓겜판독기</title>
  <link rel="stylesheet" href="./css/style_game.css">
  <!-- Quill.js CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    .board-container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px;
    }

    .board-header {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
      display: flex;
      flex-direction: column;
    }

    .board-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .board-header-left {
      flex: 1;
    }

    .board-header h1 {
      margin: 0 0 8px;
      font-size: 28px;
      font-weight: 800;
    }

    .breadcrumb {
      color: var(--ink-2);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .breadcrumb a {
      color: var(--brand);
      text-decoration: none;
    }

    .write-btn {
      padding: 8px 16px;
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }

    .write-btn:hover {
      background: #0284c7;
    }

    .write-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .post-list {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
    }

    .post-item {
      padding: 20px 24px;
      border-bottom: 1px solid var(--line);
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .post-item:hover {
      background: #f8fafc;
    }

    .post-item:last-child {
      border-bottom: none;
    }

    .post-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      color: var(--ink);
      flex: 1;
    }

    .post-meta {
      font-size: 13px;
      color: var(--ink-2);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--ink-2);
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--ink-2);
    }

    .write-form {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
    }

    /* Quill 에디터 스타일 */
    #editor {
      min-height: 300px;
      background: white;
    }

    .ql-container {
      font-size: 15px;
      font-family: inherit;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
    }

    .btn-primary {
      background: var(--brand);
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: var(--ink);
    }

    .login-notice {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      color: #92400e;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .login-notice a {
      color: #0ea5e9;
      font-weight: 600;
      text-decoration: none;
    }

    .login-notice a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="header"></div>

  <main class="board-container">
    <!-- 상단 네비게이션 버튼 -->
    <div class="game-nav-buttons">
      <button class="nav-btn" onclick="goBackToGame()">
        ⭐ 평가
      </button>
      <button class="nav-btn active">
        💬 커뮤니티
      </button>
    </div>

    <div class="board-header">
      <div class="breadcrumb">
        <a href="/home.html">홈</a> > <a href="#" id="gameLink">게임</a> > 게시판
      </div>
      <div class="board-header-top">
        <div class="board-header-left">
          <h1 id="boardTitle">게시판</h1>
        </div>
        <button class="write-btn" id="writeBtnTop" onclick="toggleWriteForm()">✏️ 글쓰기</button>
      </div>
    </div>

    <!-- 로그인 안내 -->
    <div class="login-notice" id="loginNotice" style="display: none;">
      💡 게시글을 작성하려면 <a href="/login.html">로그인</a>이 필요합니다.
    </div>

    <!-- 글쓰기 폼 -->
    <div class="write-form" id="writeForm" style="display: none;">
      <h2 style="margin-top: 0;">새 글 작성</h2>
      <div class="form-group">
        <label>제목</label>
        <input type="text" id="postTitle" placeholder="제목을 입력하세요" maxlength="200">
      </div>
      <div class="form-group">
        <label>내용</label>
        <div id="editor"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="toggleWriteForm()">취소</button>
        <button class="btn btn-primary" onclick="submitPost()">등록</button>
      </div>
    </div>

    <!-- 게시글 목록 -->
    <div class="loading" id="loading">게시글을 불러오는 중...</div>
    <div class="post-list" id="postList" style="display: none;"></div>
  </main>

  <!-- Quill.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>

  <script type="module">
    import supabase from './scripts/supabase.js';

    // Quill 에디터 초기화
    let quill = null;

    // 헤더 로드
    fetch('components/header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('header').innerHTML = html;
        const redirectURL = document.getElementById('redirect');
        redirectURL.textContent = window.location.href;
        const script = document.createElement('script');
        script.type = 'module';
        script.src = 'scripts/header_user.js';
        document.body.appendChild(script);
      });

    // URL 파라미터 가져오기
    const params = new URLSearchParams(window.location.search);
    const gameId = params.get('game_id');
    const gameSlug = params.get('slug');
    const gameTitle = decodeURIComponent(params.get('title') || '');

    // 타이틀 설정
    document.getElementById('boardTitle').textContent = `${gameTitle} 게시판`;
    document.getElementById('gameLink').textContent = gameTitle;
    document.getElementById('gameLink').href = `/game.html?id=${gameSlug}`;
    document.title = `${gameTitle} 게시판 - 갓겜판독기`;

    // 전역 변수
    let currentUser = null;
    let currentUserProfile = null;

    // 게임으로 돌아가기
    window.goBackToGame = function() {
      window.location.href = `/game.html?id=${gameSlug}`;
    };

    // 로그인 상태 확인
    async function checkAuthStatus() {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (user) {
        currentUser = user;
        
        // Users 테이블에서 프로필 정보 가져오기
        const { data: profile } = await supabase
          .from('Users')
          .select('nickname, profile_image_url')
          .eq('user_id', user.id)
          .maybeSingle();
        
        currentUserProfile = profile;
        
        // 글쓰기 버튼 활성화
        document.getElementById('writeBtnTop').disabled = false;
      } else {
        // 로그인 안 됨
        document.getElementById('loginNotice').style.display = 'block';
        document.getElementById('writeBtnTop').disabled = true;
      }
    }

    // 게시글 목록 로드
    async function loadPosts() {
      try {
        const { data, error } = await supabase
          .from('board_posts')
          .select(`
            *,
            Users!board_posts_user_id_fkey (
              nickname,
              profile_image_url
            )
          `)
          .eq('game_id', gameId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        const postList = document.getElementById('postList');
        const loading = document.getElementById('loading');

        if (!data || data.length === 0) {
          postList.innerHTML = '<div class="empty">아직 게시글이 없습니다.<br>첫 번째 글을 작성해보세요! ✍️</div>';
        } else {
          postList.innerHTML = data.map(post => {
            const author = post.Users || {};
            const nickname = author.nickname || '익명';
            const date = new Date(post.created_at).toLocaleDateString('ko-KR', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
            
            return `
              <div class="post-item" onclick="viewPost('${post.post_id}')">
                <div class="post-title">${post.title}</div>
                <div class="post-meta">
                  <span>👤 ${nickname}</span>
                  <span>📅 ${date}</span>
                  <span>👁️ ${post.views || 0}</span>
                  <span>👍 ${post.like_count || 0}</span>
                </div>
              </div>
            `;
          }).join('');
        }

        loading.style.display = 'none';
        postList.style.display = 'block';
      } catch (err) {
        console.error('Error loading posts:', err);
        document.getElementById('loading').textContent = '게시글을 불러오는데 실패했습니다.';
      }
    }

    // 글쓰기 폼 토글
    window.toggleWriteForm = function() {
      if (!currentUser) {
        alert('로그인이 필요합니다.');
        window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.href)}`;
        return;
      }

      const form = document.getElementById('writeForm');
      
      if (form.style.display === 'none') {
        form.style.display = 'block';
        
        // Quill 에디터 초기화 (처음 한 번만)
        if (!quill) {
          quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                ['clean']
              ]
            },
            placeholder: '내용을 입력하세요...'
          });
        } else {
          quill.setText('');
        }
      } else {
        form.style.display = 'none';
        document.getElementById('postTitle').value = '';
        if (quill) quill.setText('');
      }
    };

    // 게시글 등록
    window.submitPost = async function() {
      if (!currentUser) {
        alert('로그인이 필요합니다.');
        return;
      }

      const title = document.getElementById('postTitle').value.trim();
      const content = quill.root.innerHTML.trim();
      const textContent = quill.getText().trim();

      if (!title || !textContent) {
        alert('제목과 내용을 모두 입력해주세요.');
        return;
      }

      try {
        const { error } = await supabase
          .from('board_posts')
          .insert({
            game_id: gameId,
            game_slug: gameSlug,
            user_id: currentUser.id,
            title: title,
            content: content
          });

        if (error) throw error;

        alert('게시글이 등록되었습니다.');
        toggleWriteForm();
        loadPosts();
      } catch (err) {
        console.error('Error creating post:', err);
        alert('게시글 등록에 실패했습니다: ' + err.message);
      }
    };

    // 게시글 상세보기
    window.viewPost = function(postId) {
      location.href = `/board_post.html?id=${postId}`;
    };

    // 초기 로드
    checkAuthStatus();
    loadPosts();
  </script>
</body>
</html>