<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ê²Œì‹œê¸€ - ê°“ê²œíŒë…ê¸°</title>
  <link rel="stylesheet" href="./css/style_game.css">
  <!-- Quill.js CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.css" rel="stylesheet">
  <link rel="stylesheet" href="./css/style_board_post.css">
  <link rel="stylesheet" href="./css/style_review.css">
  <link rel="stylesheet" href="./css/style_board_comment.css">
</head>
<body>
  <div id="header"></div>

  <main class="post-container">
    <!-- ë¡œë”© -->
    <div class="loading" id="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>

    <!-- ì—ëŸ¬ -->
    <div class="error" id="error" style="display: none;">
      <h2>âš ï¸ ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
      <p>ì‚­ì œë˜ì—ˆê±°ë‚˜ ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œê¸€ì…ë‹ˆë‹¤.</p>
      <button class="back-btn" onclick="history.back()">â† ëŒì•„ê°€ê¸°</button>
    </div>

    <!-- ê²Œì‹œê¸€ ë‚´ìš© -->
    <div id="postContent" style="display: none;">
      <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
      <div class="game-nav-buttons">
        <button class="nav-btn" id="gameNavBtn">
          â­ í‰ê°€
        </button>
        <button class="nav-btn active">
          ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°
        </button>
      </div>

      <div class="post-header">
        <div class="breadcrumb">
          <a href="/home.html">í™ˆ</a> > 
          <a href="#" id="gameLink">ê²Œì„</a> > 
          <a href="#" id="boardLink">ê²Œì‹œíŒ</a> > 
          ê²Œì‹œê¸€
        </div>
        <h1 class="post-title" id="postTitle"></h1>
        <div class="post-meta">
          <div class="post-meta-left">
            <div class="author-info">
              <img class="author-avatar" id="authorAvatar" src="" alt="í”„ë¡œí•„">
              <span id="authorName"></span>
            </div>
            <span id="postDate"></span>
            <span>ğŸ‘ï¸ <span id="postViews"></span></span>
          </div>
          <div class="edit-delete-section" id="ownerActions" style="display: none;">
            <button class="edit-btn" onclick="editPost()">ìˆ˜ì •</button>
            <button class="delete-btn" onclick="deletePost()">ì‚­ì œ</button>
          </div>
        </div>
      </div>

      <!-- ê²Œì‹œê¸€ ë³¸ë¬¸ -->
      <div class="post-content-box" id="postContentText"></div>

      <!-- ìˆ˜ì • í¼ (ìˆ¨ê¹€ ìƒíƒœ) -->
      <div class="edit-form" id="editForm" style="display: none;">
        <div class="form-group">
          <label>ì œëª©</label>
          <input type="text" id="editTitle" maxlength="200">
        </div>
        <div class="form-group">
          <label>ë‚´ìš©</label>
          <div id="editEditor"></div>
        </div>
        <div class="form-actions">
          <button class="btn btn-secondary" onclick="cancelEdit()">ì·¨ì†Œ</button>
          <button class="btn btn-primary" onclick="saveEdit()">ì €ì¥</button>
        </div>
      </div>

      <div class="post-actions">
        <div class="like-dislike-section">
          <button class="like-btn" id="likeBtn" onclick="toggleLike()">
            ğŸ‘ ì¢‹ì•„ìš” <span id="likeCount">0</span>
          </button>
          <button class="dislike-btn" id="dislikeBtn" onclick="toggleDislike()">
            ğŸ‘ ì‹«ì–´ìš” <span id="dislikeCount">0</span>
          </button>
        </div>
        <div class="bottom-actions">
          <button class="back-btn" onclick="goBackToBoard()">â† ëª©ë¡ìœ¼ë¡œ</button>
        </div>
      </div>
    </div>
  </main>

  <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
  <section class="reviews-section" id="comments-section" style="display: none;">
    <h2>ëŒ“ê¸€ <span id="commentCountBadge">0</span></h2>

    <!-- ëŒ“ê¸€ ì‘ì„± í¼ -->
    <form class="review-composer comment-composer" id="commentForm">
      <textarea name="comment" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•´ì£¼ì„¸ìš”..." required></textarea>
      <div class="review-actions">
        <input type="reset" value="ë‹¤ì‹œì“°ê¸°" class="btn">
        <input type="submit" value="ëŒ“ê¸€ ì‘ì„±" class="btn">
      </div>
    </form>
  </section>

  <!-- ëŒ“ê¸€ ëª©ë¡ -->
  <section class="reviews-view" id="comments-view" style="display: none;">
    <div class="reviews-toolbar">
      <button type="button" class="sort-btn active" data-sort="time">ì‹œê°„ìˆœ â–¾</button>
      <button type="button" class="sort-btn" data-sort="like">ì¶”ì²œìˆœ â–¾</button>
    </div>

    <div id="comment-list" class="review-list" aria-live="polite"></div>

    <button id="load-more" class="loadmore-btn" type="button" style="display: none;">ì¶”ê°€ ë³´ê¸°</button>
  </section>

  <!-- Quill.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>

  <script type="module">
    import supabase from './scripts/supabase.js';

    let editQuill = null;

    // í—¤ë” ë¡œë“œ
    fetch('components/header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('header').innerHTML = html;
        const redirectURL = document.getElementById('redirect');
        redirectURL.textContent = window.location.href;
        const script = document.createElement('script');
        script.type = 'module';
        script.src = 'scripts/header_user.js';
        document.body.appendChild(script);
      });

    // URL íŒŒë¼ë¯¸í„°
    const params = new URLSearchParams(window.location.search);
    const postId = params.get('id');

    let currentUser = null;
    let currentPost = null;

    if (!postId) {
      document.getElementById('loading').style.display = 'none';
      document.getElementById('error').style.display = 'block';
    } else {
      loadPost();
    }

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    async function checkAuthStatus() {
      const { data: { user } } = await supabase.auth.getUser();
      currentUser = user;
      
      // ë³¸ì¸ ê²Œì‹œê¸€ì´ë©´ ìˆ˜ì •/ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
      if (user && currentPost && user.id === currentPost.user_id) {
        document.getElementById('ownerActions').style.display = 'flex';
      }
    }

    // ê²Œì‹œê¸€ ë¡œë“œ
    async function loadPost() {
      try {
        // ì¡°íšŒìˆ˜ ì¦ê°€
        await supabase.rpc('increment_post_views', { post_id: postId });

        // ê²Œì‹œê¸€ ì¡°íšŒ
        const { data, error } = await supabase
          .from('board_posts')
          .select(`
            *,
            Users!board_posts_user_id_fkey (
              nickname,
              profile_image_url
            )
          `)
          .eq('post_id', postId)
          .single();

        if (error || !data) throw new Error('ê²Œì‹œê¸€ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');

        currentPost = data;
        const author = data.Users || {};

        // í˜ì´ì§€ íƒ€ì´í‹€
        document.title = `${data.title} - ê°“ê²œíŒë…ê¸°`;

        // ë„¤ë¹„ê²Œì´ì…˜ ë§í¬ ì„¤ì •
        document.getElementById('gameLink').textContent = data.game_title || 'ê²Œì„';
        document.getElementById('gameLink').href = `/game.html?id=${data.game_slug}`;
        document.getElementById('boardLink').href = `/board.html?game_id=${data.game_id}&slug=${data.game_slug}&title=${encodeURIComponent(data.game_title || '')}`;
        document.getElementById('gameNavBtn').onclick = () => {
          window.location.href = `/game.html?id=${data.game_slug}`;
        };

        // ê²Œì‹œê¸€ ë‚´ìš©
        document.getElementById('postTitle').textContent = data.title;
        document.getElementById('authorAvatar').src = author.profile_image_url || '';
        document.getElementById('authorName').textContent = author.nickname || 'ìµëª…';
        document.getElementById('postDate').textContent = new Date(data.created_at).toLocaleDateString('ko-KR', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        document.getElementById('postViews').textContent = data.views || 0;
        document.getElementById('postContentText').innerHTML = data.content;
        document.getElementById('likeCount').textContent = data.like_count || 0;
        document.getElementById('dislikeCount').textContent = data.dislike_count || 0;

        // í™”ë©´ í‘œì‹œ
        document.getElementById('loading').style.display = 'none';
        document.getElementById('postContent').style.display = 'block';
        document.getElementById('comments-section').style.display = 'block';
        document.getElementById('comments-view').style.display = 'block';

      // ë¡œê·¸ì¸ í™•ì¸
      await checkAuthStatus();

      // [ìˆ˜ì •ë¨] ì‚¬ìš©ìì˜ íˆ¬í‘œ ìƒíƒœ ë¶ˆëŸ¬ì˜¤ê¸° (í…Œì´ë¸”ëª… postvotes ì†Œë¬¸ì ì£¼ì˜!)
      if (currentUser) {
        const { data: userVote, error } = await supabase
          .from('postvotes')  // SQL í…Œì´ë¸”ëª…ì— ë§ì¶° ì†Œë¬¸ìë¡œ ë³€ê²½
          .select('vote_type')
          .eq('post_id', postId)
          .eq('user_id', currentUser.id)
          .maybeSingle();

        if (userVote) {
          if (userVote.vote_type === 'like') {
            document.getElementById('likeBtn').classList.add('active');
          } else if (userVote.vote_type === 'dislike') {
            document.getElementById('dislikeBtn').classList.add('active');
          }
        }
      }

        // ëŒ“ê¸€ ì‹œìŠ¤í…œ ì´ˆê¸°í™”
        initCommentSystem();

      } catch (err) {
        console.error('Error loading post:', err);
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
      }
    }

    // ê²Œì‹œíŒìœ¼ë¡œ ëŒì•„ê°€ê¸°
    window.goBackToBoard = function() {
      if (currentPost) {
        window.location.href = `/board.html?game_id=${currentPost.game_id}&slug=${currentPost.game_slug}&title=${encodeURIComponent(currentPost.game_title || '')}`;
      } else {
        history.back();
      }
    };

    // ì¢‹ì•„ìš” í† ê¸€ í•¨ìˆ˜ (ìµœì¢… ìˆ˜ì •: í…Œì´ë¸”ëª… postvotes ì ìš©)
    window.toggleLike = async function() {
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      try {
        const likeBtn = document.getElementById('likeBtn');
        const dislikeBtn = document.getElementById('dislikeBtn');
        const isLiked = likeBtn.classList.contains('active');

        // 1. ì‹«ì–´ìš”ê°€ ëˆŒë ¤ìˆì—ˆë‹¤ë©´ -> ì‹«ì–´ìš” ì·¨ì†Œë§Œ (PostVotes ì‚­ì œëŠ” upsertê°€ ì•Œì•„ì„œ ì²˜ë¦¬í•˜ê±°ë‚˜ ë®ì–´ì”Œì›€)
        // í™”ë©´ìƒ ì¹´ìš´íŠ¸ ê°ì†Œ ì²˜ë¦¬ëŠ” í•„ìˆ˜
        if (dislikeBtn.classList.contains('active')) {
          const newDislikeCount = Math.max(0, (currentPost.dislike_count || 0) - 1);
          await supabase.from('board_posts').update({ dislike_count: newDislikeCount }).eq('post_id', postId);
          currentPost.dislike_count = newDislikeCount;
          document.getElementById('dislikeCount').textContent = newDislikeCount;
          dislikeBtn.classList.remove('active');
        }

        // 2. ì¢‹ì•„ìš” ì²˜ë¦¬
        if (isLiked) {
          // [ì·¨ì†Œ]
          const newCount = Math.max(0, (currentPost.like_count || 0) - 1);
          
          await supabase.from('board_posts').update({ like_count: newCount }).eq('post_id', postId);
          
          // ë‚´ ê¸°ë¡ ì‚­ì œ
          await supabase
            .from('postvotes') // ì†Œë¬¸ì
            .delete()
            .eq('post_id', postId)
            .eq('user_id', currentUser.id);

          currentPost.like_count = newCount;
          document.getElementById('likeCount').textContent = newCount;
          likeBtn.classList.remove('active');

        } else {
          // [ë“±ë¡]
          const newCount = (currentPost.like_count || 0) + 1;

          await supabase.from('board_posts').update({ like_count: newCount }).eq('post_id', postId);

          // ë‚´ ê¸°ë¡ ì €ì¥ (Upsert)
          const { error } = await supabase
            .from('postvotes') // ì†Œë¬¸ì
            .upsert({ 
              post_id: postId, 
              user_id: currentUser.id, 
              vote_type: 'like' 
            }, { onConflict: 'post_id, user_id' }); // SQLì— ì„¤ì •í•œ unique ì œì•½ì¡°ê±´ í™œìš©

          if (error) throw error;

          currentPost.like_count = newCount;
          document.getElementById('likeCount').textContent = newCount;
          likeBtn.classList.add('active');
        }
      } catch (err) {
        console.error('Error:', err);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ì‹«ì–´ìš” í† ê¸€ í•¨ìˆ˜ (ìµœì¢… ìˆ˜ì •: í…Œì´ë¸”ëª… postvotes ì ìš©)
    window.toggleDislike = async function() {
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      try {
        const likeBtn = document.getElementById('likeBtn');
        const dislikeBtn = document.getElementById('dislikeBtn');
        const isDisliked = dislikeBtn.classList.contains('active');

        // 1. ì¢‹ì•„ìš”ê°€ ëˆŒë ¤ìˆì—ˆë‹¤ë©´ -> ì·¨ì†Œ
        if (likeBtn.classList.contains('active')) {
          const newLikeCount = Math.max(0, (currentPost.like_count || 0) - 1);
          await supabase.from('board_posts').update({ like_count: newLikeCount }).eq('post_id', postId);
          currentPost.like_count = newLikeCount;
          document.getElementById('likeCount').textContent = newLikeCount;
          likeBtn.classList.remove('active');
        }

        // 2. ì‹«ì–´ìš” ì²˜ë¦¬
        if (isDisliked) {
          // [ì·¨ì†Œ]
          const newCount = Math.max(0, (currentPost.dislike_count || 0) - 1);
          
          await supabase.from('board_posts').update({ dislike_count: newCount }).eq('post_id', postId);

          // ë‚´ ê¸°ë¡ ì‚­ì œ
          await supabase
            .from('postvotes') // ì†Œë¬¸ì
            .delete()
            .eq('post_id', postId)
            .eq('user_id', currentUser.id);

          currentPost.dislike_count = newCount;
          document.getElementById('dislikeCount').textContent = newCount;
          dislikeBtn.classList.remove('active');

        } else {
          // [ë“±ë¡]
          const newCount = (currentPost.dislike_count || 0) + 1;

          await supabase.from('board_posts').update({ dislike_count: newCount }).eq('post_id', postId);

          // ë‚´ ê¸°ë¡ ì €ì¥ (Upsert)
          const { error } = await supabase
            .from('postvotes') // ì†Œë¬¸ì
            .upsert({ 
              post_id: postId, 
              user_id: currentUser.id, 
              vote_type: 'dislike' 
            }, { onConflict: 'post_id, user_id' });

          if (error) throw error;

          currentPost.dislike_count = newCount;
          document.getElementById('dislikeCount').textContent = newCount;
          dislikeBtn.classList.add('active');
        }
      } catch (err) {
        console.error('Error:', err);
        alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ìˆ˜ì • ëª¨ë“œ ì§„ì…
    window.editPost = function() {
      document.getElementById('postContentText').style.display = 'none';
      document.getElementById('editForm').style.display = 'block';
      document.getElementById('editTitle').value = currentPost.title;

      if (!editQuill) {
        editQuill = new Quill('#editEditor', {
          theme: 'snow',
          modules: {
            toolbar: [
              [{ 'header': [1, 2, 3, false] }],
              [{ 'size': ['small', false, 'large', 'huge'] }],
              ['bold', 'italic', 'underline', 'strike'],
              [{ 'color': [] }, { 'background': [] }],
              [{ 'list': 'ordered'}, { 'list': 'bullet' }],
              ['link'],
              ['clean']
            ]
          }
        });
      }
      
      editQuill.root.innerHTML = currentPost.content;
    };

    // ìˆ˜ì • ì·¨ì†Œ
    window.cancelEdit = function() {
      document.getElementById('postContentText').style.display = 'block';
      document.getElementById('editForm').style.display = 'none';
    };

    // ìˆ˜ì • ì €ì¥
    window.saveEdit = async function() {
      const newTitle = document.getElementById('editTitle').value.trim();
      const newContent = editQuill.root.innerHTML.trim();
      const textContent = editQuill.getText().trim();

      if (!newTitle || !textContent) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const { error } = await supabase
          .from('board_posts')
          .update({
            title: newTitle,
            content: newContent,
            updated_at: new Date().toISOString()
          })
          .eq('post_id', postId);

        if (error) throw error;

        alert('ê²Œì‹œê¸€ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        currentPost.title = newTitle;
        currentPost.content = newContent;
        document.getElementById('postTitle').textContent = newTitle;
        document.getElementById('postContentText').innerHTML = newContent;
        
        cancelEdit();
      } catch (err) {
        console.error('Error:', err);
        alert('ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ì‚­ì œ
    window.deletePost = async function() {
      if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

      try {
        const { error } = await supabase
          .from('board_posts')
          .delete()
          .eq('post_id', postId);

        if (error) throw error;

        alert('ê²Œì‹œê¸€ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        goBackToBoard();
      } catch (err) {
        console.error('Error:', err);
        alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    };

    // ========== ëŒ“ê¸€ ì‹œìŠ¤í…œ ==========
    const USERS_TABLE = 'Users';
    const USER_PK_COL = 'user_id';
    const PAGE_SIZE = 10;
    
    let commentPage = 0;
    let sortMode = 'time';
    let CURRENT_USER_ID = null;

    async function initCommentSystem() {
      const { data: { user } } = await supabase.auth.getUser();
      CURRENT_USER_ID = user?.id || null;

      // ë¡œê·¸ì¸ ìƒíƒœ ë³€í™” ê°ì§€
      supabase.auth.onAuthStateChange(async (_event, session) => {
        const newId = session?.user?.id || null;
        if (newId !== CURRENT_USER_ID) {
          CURRENT_USER_ID = newId;
          await reloadComments();
        }
      });

      bindCommentEvents();
      await reloadComments();
    }

    function bindCommentEvents() {
      const sortBtns = document.querySelectorAll('.sort-btn');
      const loadMoreBtn = document.getElementById('load-more');
      const commentForm = document.getElementById('commentForm');
      const commentList = document.getElementById('comment-list');

      // ì •ë ¬
      sortBtns.forEach(btn => {
        btn.addEventListener('click', async () => {
          if (btn.classList.contains('active')) return;
          sortBtns.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          sortMode = btn.dataset.sort;
          await reloadComments();
        });
      });

      // ë”ë³´ê¸°
      loadMoreBtn?.addEventListener('click', async () => {
        commentPage += 1;
        await fetchAndRenderComments({ append: true });
      });

      // ëŒ“ê¸€ ì‘ì„±
      commentForm?.addEventListener('submit', onSubmitComment);

      // íˆ¬í‘œ & ë‹µê¸€ í† ê¸€
      commentList.addEventListener('click', onCommentVoteClick);
      commentList.addEventListener('click', onRepliesToggle);
      commentList.addEventListener('submit', onReplySubmit);
    }

    async function onSubmitComment(e) {
      e.preventDefault();

      if (!CURRENT_USER_ID) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.');
        location.href = `./login.html?redirect=${encodeURIComponent(location.href)}`;
        return;
      }

      const fd = new FormData(e.target);
      const content = String(fd.get('comment') || '').trim();

      if (!content) {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      const { error } = await supabase.from('Comments').insert({
        post_id: postId,
        user_id: CURRENT_USER_ID,
        content,
        parent_comment_id: null,
        game_id: null,
        rating: null,
        is_recommended: null
      });

      if (error) {
        alert('ì €ì¥ ì‹¤íŒ¨: ' + error.message);
        return;
      }

      e.target.reset();
      await reloadComments();
    }

    async function onCommentVoteClick(e) {
      const btn = e.target.closest('.vote-btn');
      if (!btn) return;

      if (!CURRENT_USER_ID) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.');
        location.href = `./login.html?redirect=${encodeURIComponent(location.href)}`;
        return;
      }

      const card = btn.closest('[data-owner]');
      const ownerId = card?.dataset.owner;
      if (ownerId && ownerId === CURRENT_USER_ID) {
        alert('ë³¸ì¸ ëŒ“ê¸€ì—ëŠ” ì¶”ì²œ/ë¹„ì¶”ì²œì„ í•  ìˆ˜ ì—†ì–´ìš”.');
        return;
      }

      const commentId = btn.dataset.id;
      const want = btn.classList.contains('like') ? 1 : -1;

      const { data: existing, error: qErr } = await supabase
        .from('CommentVotes')
        .select('vote_id, value')
        .eq('comment_id', commentId)
        .eq('user_id', CURRENT_USER_ID)
        .maybeSingle();

      if (qErr) {
        alert('ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        return;
      }

      let opErr = null;

      if (!existing) {
        const { error } = await supabase.from('CommentVotes').insert({
          comment_id: commentId,
          user_id: CURRENT_USER_ID,
          value: want
        });
        opErr = error;
      } else if (existing.value === want) {
        const { error } = await supabase
          .from('CommentVotes')
          .delete()
          .eq('vote_id', existing.vote_id);
        opErr = error;
      } else {
        const { error } = await supabase
          .from('CommentVotes')
          .update({ value: want })
          .eq('vote_id', existing.vote_id);
        opErr = error;
      }

      if (opErr) {
        alert('íˆ¬í‘œ ì‹¤íŒ¨: ' + opErr.message);
        return;
      }

      await reloadComments();
    }

    async function onRepliesToggle(e) {
      const t = e.target.closest('.replies-toggle');
      if (!t) return;

      const parentId = t.dataset.id;
      if (!parentId) return;

      const box = document.getElementById(`replies-${parentId}`);
      if (!box) return;

      const isHidden = box.classList.contains('hidden') || box.hasAttribute('hidden');

      if (isHidden) {
        if (!box.dataset.loaded) {
          await loadReplies(parentId, box);
          box.dataset.loaded = '1';
        }
        box.classList.remove('hidden');
        box.removeAttribute('hidden');
        t.setAttribute('aria-expanded', 'true');
      } else {
        box.classList.add('hidden');
        t.setAttribute('aria-expanded', 'false');
      }
    }

    async function onReplySubmit(e) {
      const form = e.target.closest('.reply-form');
      if (!form) return;
      e.preventDefault();

      if (!CURRENT_USER_ID) {
        alert('ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.');
        location.href = `./login.html?redirect=${encodeURIComponent(location.href)}`;
        return;
      }

      const parentId = form.dataset.parent;
      const ta = form.querySelector('textarea');
      const content = String(ta?.value || '').trim();
      if (!content) {
        alert('ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      const { error } = await supabase.from('Comments').insert({
        post_id: postId,
        user_id: CURRENT_USER_ID,
        content,
        parent_comment_id: parentId,
        game_id: null,
        rating: null,
        is_recommended: null
      });

      if (error) {
        alert('ë“±ë¡ ì‹¤íŒ¨: ' + error.message);
        return;
      }

      if (ta) ta.value = '';

      const box = document.getElementById(`replies-${parentId}`);
      if (box) {
        const count = await loadReplies(parentId, box);
        const toggle = document.querySelector(`.replies-toggle[data-id="${parentId}"] .reply-count`);
        if (toggle) toggle.textContent = String(count);
      }
    }

    async function loadReplies(parentId, box) {
      const { data: replies, error } = await supabase
        .from('Comments')
        .select('comment_id,user_id,content,created_at,like_count,dislike_count')
        .eq('parent_comment_id', parentId)
        .order('created_at', { ascending: true });

      if (error) {
        box.innerHTML = `<div class="empty-replies">ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨</div>`;
        return 0;
      }

      const uids = [...new Set((replies || []).map(r => r.user_id))];
      let uMap = new Map();
      if (uids.length) {
        const { data: users } = await supabase
          .from(USERS_TABLE)
          .select(`${USER_PK_COL}, nickname, profile_image_url`)
          .in(USER_PK_COL, uids);
        uMap = new Map((users || []).map(u => [u[USER_PK_COL], u]));
      }

      let voteMap = new Map();
      if (CURRENT_USER_ID && replies?.length) {
        const ids = replies.map(r => r.comment_id);
        const { data: myVotes } = await supabase
          .from('CommentVotes')
          .select('comment_id,value')
          .eq('user_id', CURRENT_USER_ID)
          .in('comment_id', ids);
        voteMap = new Map((myVotes || []).map(v => [v.comment_id, v.value]));
      }

      const composer = CURRENT_USER_ID
        ? `<form class="reply-form" data-parent="${parentId}">
            <div class="reply-form-row">
              <textarea name="reply" placeholder="ë‹µê¸€ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”" required></textarea>
              <button type="submit" class="btn reply-send">ê²Œì‹œ</button>
            </div>
          </form>`
        : `<div class="reply-login-hint">ë¡œê·¸ì¸ í›„ ë‹µê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆì–´ìš”.</div>`;

      const items = (replies || []).map(r => {
        const u = uMap.get(r.user_id) || {};
        const likeAct = voteMap.get(r.comment_id) === 1 ? 'active' : '';
        const dislikeAct = voteMap.get(r.comment_id) === -1 ? 'active' : '';
        const avatar = (u.profile_image_url && typeof u.profile_image_url === 'string')
          ? u.profile_image_url
          : `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(r.user_id || 'anon')}`;

        const needLogin = !CURRENT_USER_ID;
        const isOwn = CURRENT_USER_ID && r.user_id === CURRENT_USER_ID;
        const disable = needLogin || isOwn;
        const titleTip = needLogin ? 'ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.' : (isOwn ? 'ë³¸ì¸ ëŒ“ê¸€ì—ëŠ” ì¶”ì²œ/ë¹„ì¶”ì²œì„ í•  ìˆ˜ ì—†ì–´ìš”.' : '');
        const disAttr = disable ? `disabled aria-disabled="true" title="${titleTip}"` : '';
        const disCls = disable ? ' disabled' : '';

        return `
          <article class="reply-card" data-id="${r.comment_id}" data-owner="${r.user_id}">
            <div class="avatar"><img src="${esc(avatar)}" alt=""></div>
            <div class="reply-main">
              <div class="reply-user">${esc(u.nickname || 'ìµëª…')}</div>
              <p class="reply-content">${esc(r.content || '')}</p>
              <time class="reply-time">${r.created_at ? new Date(r.created_at).toLocaleString('ko-KR') : ''}</time>
            </div>
            <div class="reply-actions-top">
              <button class="vote-btn small like ${likeAct}${disCls}" data-id="${r.comment_id}" ${disAttr}>
                ğŸ‘ <span class="count">${r.like_count ?? 0}</span>
              </button>
              <button class="vote-btn small dislike ${dislikeAct}${disCls}" data-id="${r.comment_id}" ${disAttr}>
                ğŸ‘ <span class="count">${r.dislike_count ?? 0}</span>
              </button>
            </div>
          </article>
        `;
      }).join('');

      box.innerHTML = composer + items;
      return replies?.length || 0;
    }

    async function reloadComments() {
      commentPage = 0;
      await fetchAndRenderComments({ append: false });
    }

    async function fetchAndRenderComments({ append }) {
      const orderCol = (sortMode === 'like') ? 'like_count' : 'created_at';
      const ascending = false;

      const from = commentPage * PAGE_SIZE;
      const to = from + PAGE_SIZE - 1;

      const { data: comments, error, count } = await supabase
        .from('Comments')
        .select('comment_id, user_id, content, like_count, dislike_count, reply_count, created_at', { count: 'exact' })
        .eq('post_id', postId)
        .is('parent_comment_id', null)
        .order(orderCol, { ascending })
        .range(from, to);

      if (error) {
        document.getElementById('comment-list').innerHTML = '<p class="error">ëŒ“ê¸€ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</p>';
        return;
      }

      // ì´ ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
      document.getElementById('commentCountBadge').textContent = count || 0;

      const userIds = Array.from(new Set((comments || []).map(r => r.user_id).filter(Boolean)));
      let profileMap = new Map();
      if (userIds.length) {
        const { data: users } = await supabase
          .from(USERS_TABLE)
          .select(`${USER_PK_COL}, nickname, profile_image_url`)
          .in(USER_PK_COL, userIds);
        profileMap = new Map((users || []).map(u => [u[USER_PK_COL], u]));
      }

      let topVotesMap = new Map();
      if (CURRENT_USER_ID && comments?.length) {
        const ids = comments.map(c => c.comment_id);
        const { data: myVotes } = await supabase
          .from('CommentVotes')
          .select('comment_id,value')
          .eq('user_id', CURRENT_USER_ID)
          .in('comment_id', ids);
        topVotesMap = new Map((myVotes || []).map(v => [v.comment_id, v.value]));
      }

      const rows = (comments || []).map(r => {
        const u = profileMap.get(r.user_id);
        const nickname = u?.nickname || ('User-' + String(r.user_id || '').slice(0, 8));
        const avatar = (u?.profile_image_url && typeof u.profile_image_url === 'string')
          ? u.profile_image_url
          : `https://api.dicebear.com/7.x/identicon/svg?seed=${encodeURIComponent(r.user_id || 'anon')}`;
        const myVote = topVotesMap.get(r.comment_id) || 0;
        return renderCommentItem({ ...r, nickname, avatar, myVote });
      });

      const html = rows.join('');
      const listEl = document.getElementById('comment-list');
      
      if (append) {
        listEl?.insertAdjacentHTML('beforeend', html);
      } else {
        listEl.innerHTML = html || '<p class="empty">ì•„ì§ ëŒ“ê¸€ì´ ì—†ì–´ìš”. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ ë³´ì„¸ìš”!</p>';
      }

      const shown = Math.min(to + 1, count ?? 0);
      const loadMoreBtn = document.getElementById('load-more');
      if (loadMoreBtn) {
        loadMoreBtn.style.display = (!!count && shown < count) ? '' : 'none';
      }
    }

    function renderCommentItem(r) {
      const timeTxt = r.created_at ? new Date(r.created_at).toLocaleString('ko-KR') : '';
      const like = r.like_count ?? 0;
      const dislike = r.dislike_count ?? 0;

      const needLogin = !CURRENT_USER_ID;
      const isOwn = CURRENT_USER_ID && r.user_id === CURRENT_USER_ID;
      const disableVote = needLogin || isOwn;
      const reason = needLogin
        ? 'ë¡œê·¸ì¸ í›„ ì´ìš©í•  ìˆ˜ ìˆì–´ìš”.'
        : 'ë³¸ì¸ ëŒ“ê¸€ì—ëŠ” ì¶”ì²œ/ë¹„ì¶”ì²œì„ í•  ìˆ˜ ì—†ì–´ìš”.';
      const disAttr = disableVote ? `disabled aria-disabled="true" title="${reason}"` : '';
      const disCls = disableVote ? ' disabled' : '';

      const likeAct = r.myVote === 1 ? 'active' : '';
      const dislikeAct = r.myVote === -1 ? 'active' : '';

      return `
        <article class="review-card" data-id="${r.comment_id}" data-owner="${r.user_id}">
          <div class="avatar">
            <img src="${esc(r.avatar)}" alt="" />
          </div>

          <div class="review-meta">
            <div class="review-headline">
              <strong class="review-user">${esc(r.nickname)}</strong>
              <time class="review-time" datetime="${r.created_at || ''}">${esc(timeTxt)}</time>
            </div>

            <p class="review-content">${esc(r.content || '')}</p>

            <div class="review-actions-row">
              <button class="vote-btn like ${likeAct}${disCls}" data-id="${r.comment_id}" ${disAttr} aria-label="ì¶”ì²œ">
                ğŸ‘ <span class="count">${like}</span>
              </button>
              <button class="vote-btn dislike ${dislikeAct}${disCls}" data-id="${r.comment_id}" ${disAttr} aria-label="ë¹„ì¶”ì²œ">
                ğŸ‘ <span class="count">${dislike}</span>
              </button>

              <button class="replies-toggle" data-id="${r.comment_id}" aria-expanded="false" title="ë‹µê¸€ ë³´ê¸°">
                ğŸ’¬ <span class="reply-count">${r.reply_count || 0}</span>
              </button>
            </div>

            <div class="replies hidden" id="replies-${r.comment_id}"></div>
          </div>
        </article>
      `;
    }

    function esc(s) {
      return String(s ?? '')
        .replaceAll('&', '&amp;')
        .replaceAll('<', '&lt;')
        .replaceAll('>', '&gt;')
        .replaceAll('"', '&quot;')
        .replaceAll("'", '&#39;');
    }
  </script>
</body>
</html>