<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ê²Œì‹œíŒ - ê°“ê²œíŒë…ê¸°</title>
  <link rel="stylesheet" href="./css/style_game.css">
  <!-- Quill.js CSS -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.snow.css" rel="stylesheet">
  <style>
    .board-container {
      max-width: 1200px;
      margin: 24px auto;
      padding: 0 16px;
    }

    .board-header {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
      display: flex;
      flex-direction: column;
    }

    .board-header-top {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .board-header-left {
      flex: 1;
    }

    .board-header h1 {
      margin: 0 0 8px;
      font-size: 28px;
      font-weight: 800;
    }

    .breadcrumb {
      color: var(--ink-2);
      font-size: 14px;
      margin-bottom: 16px;
    }

    .breadcrumb a {
      color: var(--brand);
      text-decoration: none;
    }

    .write-btn {
      padding: 8px 16px;
      background: var(--brand);
      color: white;
      border: none;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    }

    .write-btn:hover {
      background: #0284c7;
    }

    .write-btn:disabled {
      background: #94a3b8;
      cursor: not-allowed;
    }

    .post-list {
      background: white;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
    }

    .post-item {
      padding: 20px 24px;
      border-bottom: 1px solid var(--line);
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .post-item:hover {
      background: #f8fafc;
    }

    .post-item:last-child {
      border-bottom: none;
    }

    .post-title {
      font-size: 16px;
      font-weight: 600;
      margin: 0;
      color: var(--ink);
      flex: 1;
    }

    .post-meta {
      font-size: 13px;
      color: var(--ink-2);
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      flex-shrink: 0;
    }

    .empty {
      text-align: center;
      padding: 60px 20px;
      color: var(--ink-2);
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: var(--ink-2);
    }

    .write-form {
      background: white;
      border-radius: 16px;
      padding: 32px;
      margin-bottom: 24px;
      box-shadow: 0 6px 18px rgba(0, 0, 0, .06);
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      font-size: 14px;
    }

    .form-group input {
      width: 100%;
      padding: 12px;
      border: 1px solid var(--line);
      border-radius: 8px;
      font-size: 15px;
      font-family: inherit;
    }

    /* Quill ì—ë””í„° ìŠ¤íƒ€ì¼ */
    #editor {
      min-height: 300px;
      background: white;
    }

    .ql-container {
      font-size: 15px;
      font-family: inherit;
    }

    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
    }

    .btn {
      padding: 12px 24px;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
      font-size: 15px;
    }

    .btn-primary {
      background: var(--brand);
      color: white;
    }

    .btn-secondary {
      background: #e5e7eb;
      color: var(--ink);
    }

    .login-notice {
      background: #fef3c7;
      border: 1px solid #fbbf24;
      color: #92400e;
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
      font-size: 14px;
    }

    .login-notice a {
      color: #0ea5e9;
      font-weight: 600;
      text-decoration: none;
    }

    .login-notice a:hover {
      text-decoration: underline;
    }
  </style>
</head>
<body>
  <div id="header"></div>

  <main class="board-container">
    <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ -->
    <div class="game-nav-buttons">
      <button class="nav-btn" onclick="goBackToGame()">
        â­ í‰ê°€
      </button>
      <button class="nav-btn active">
        ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°
      </button>
    </div>

    <div class="board-header">
      <div class="breadcrumb">
        <a href="/home.html">í™ˆ</a> > <a href="#" id="gameLink">ê²Œì„</a> > ê²Œì‹œíŒ
      </div>
      <div class="board-header-top">
        <div class="board-header-left">
          <h1 id="boardTitle">ê²Œì‹œíŒ</h1>
        </div>
        <button class="write-btn" id="writeBtnTop" onclick="toggleWriteForm()">âœï¸ ê¸€ì“°ê¸°</button>
      </div>
    </div>

    <!-- ë¡œê·¸ì¸ ì•ˆë‚´ -->
    <div class="login-notice" id="loginNotice" style="display: none;">
      ğŸ’¡ ê²Œì‹œê¸€ì„ ì‘ì„±í•˜ë ¤ë©´ <a href="/login.html">ë¡œê·¸ì¸</a>ì´ í•„ìš”í•©ë‹ˆë‹¤.
    </div>

    <!-- ê¸€ì“°ê¸° í¼ -->
    <div class="write-form" id="writeForm" style="display: none;">
      <h2 style="margin-top: 0;">ìƒˆ ê¸€ ì‘ì„±</h2>
      <div class="form-group">
        <label>ì œëª©</label>
        <input type="text" id="postTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" maxlength="200">
      </div>
      <div class="form-group">
        <label>ë‚´ìš©</label>
        <div id="editor"></div>
      </div>
      <div class="form-actions">
        <button class="btn btn-secondary" onclick="toggleWriteForm()">ì·¨ì†Œ</button>
        <button class="btn btn-primary" onclick="submitPost()">ë“±ë¡</button>
      </div>
    </div>

    <!-- ê²Œì‹œê¸€ ëª©ë¡ -->
    <div class="loading" id="loading">ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>
    <div class="post-list" id="postList" style="display: none;"></div>
  </main>

  <!-- Quill.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quill/1.3.7/quill.min.js"></script>

  <script type="module">
    import supabase from './scripts/supabase.js';

    // Quill ì—ë””í„° ì´ˆê¸°í™”
    let quill = null;

    // í—¤ë” ë¡œë“œ
    fetch('components/header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('header').innerHTML = html;
        const redirectURL = document.getElementById('redirect');
        redirectURL.textContent = window.location.href;
        const script = document.createElement('script');
        script.type = 'module';
        script.src = 'scripts/header_user.js';
        document.body.appendChild(script);
      });

    // URL íŒŒë¼ë¯¸í„° ê°€ì ¸ì˜¤ê¸°
    const params = new URLSearchParams(window.location.search);
    const gameId = params.get('game_id');
    const gameSlug = params.get('slug');
    const gameTitle = decodeURIComponent(params.get('title') || '');

    // íƒ€ì´í‹€ ì„¤ì •
    document.getElementById('boardTitle').textContent = `${gameTitle} ê²Œì‹œíŒ`;
    document.getElementById('gameLink').textContent = gameTitle;
    document.getElementById('gameLink').href = `/game.html?id=${gameSlug}`;
    document.title = `${gameTitle} ê²Œì‹œíŒ - ê°“ê²œíŒë…ê¸°`;

    // ì „ì—­ ë³€ìˆ˜
    let currentUser = null;
    let currentUserProfile = null;

    // ê²Œì„ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    window.goBackToGame = function() {
      window.location.href = `/game.html?id=${gameSlug}`;
    };

    // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
    async function checkAuthStatus() {
      const { data: { user } } = await supabase.auth.getUser();
      
      if (user) {
        currentUser = user;
        
        // Users í…Œì´ë¸”ì—ì„œ í”„ë¡œí•„ ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const { data: profile } = await supabase
          .from('Users')
          .select('nickname, profile_image_url')
          .eq('user_id', user.id)
          .maybeSingle();
        
        currentUserProfile = profile;
        
        // ê¸€ì“°ê¸° ë²„íŠ¼ í™œì„±í™”
        document.getElementById('writeBtnTop').disabled = false;
      } else {
        // ë¡œê·¸ì¸ ì•ˆ ë¨
        document.getElementById('loginNotice').style.display = 'block';
        document.getElementById('writeBtnTop').disabled = true;
      }
    }

    // ê²Œì‹œê¸€ ëª©ë¡ ë¡œë“œ
    async function loadPosts() {
      try {
        const { data, error } = await supabase
          .from('board_posts')
          .select(`
            *,
            Users!board_posts_user_id_fkey (
              nickname,
              profile_image_url
            )
          `)
          .eq('game_id', gameId)
          .order('created_at', { ascending: false });

        if (error) throw error;

        const postList = document.getElementById('postList');
        const loading = document.getElementById('loading');

        if (!data || data.length === 0) {
          postList.innerHTML = '<div class="empty">ì•„ì§ ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤.<br>ì²« ë²ˆì§¸ ê¸€ì„ ì‘ì„±í•´ë³´ì„¸ìš”! âœï¸</div>';
        } else {
          postList.innerHTML = data.map(post => {
            const author = post.Users || {};
            const nickname = author.nickname || 'ìµëª…';
            const date = new Date(post.created_at).toLocaleDateString('ko-KR', {
              year: 'numeric',
              month: 'long',
              day: 'numeric'
            });
            
            return `
              <div class="post-item" onclick="viewPost('${post.post_id}')">
                <div class="post-title">${post.title}</div>
                <div class="post-meta">
                  <span>ğŸ‘¤ ${nickname}</span>
                  <span>ğŸ“… ${date}</span>
                  <span>ğŸ‘ï¸ ${post.views || 0}</span>
                  <span>ğŸ‘ ${post.like_count || 0}</span>
                </div>
              </div>
            `;
          }).join('');
        }

        loading.style.display = 'none';
        postList.style.display = 'block';
      } catch (err) {
        console.error('Error loading posts:', err);
        document.getElementById('loading').textContent = 'ê²Œì‹œê¸€ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.';
      }
    }

    // ê¸€ì“°ê¸° í¼ í† ê¸€
    window.toggleWriteForm = function() {
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = `/login.html?redirect=${encodeURIComponent(window.location.href)}`;
        return;
      }

      const form = document.getElementById('writeForm');
      
      if (form.style.display === 'none') {
        form.style.display = 'block';
        
        // Quill ì—ë””í„° ì´ˆê¸°í™” (ì²˜ìŒ í•œ ë²ˆë§Œ)
        if (!quill) {
          quill = new Quill('#editor', {
            theme: 'snow',
            modules: {
              toolbar: [
                [{ 'header': [1, 2, 3, false] }],
                [{ 'size': ['small', false, 'large', 'huge'] }],
                ['bold', 'italic', 'underline', 'strike'],
                [{ 'color': [] }, { 'background': [] }],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['link'],
                ['clean']
              ]
            },
            placeholder: 'ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”...'
          });
        } else {
          quill.setText('');
        }
      } else {
        form.style.display = 'none';
        document.getElementById('postTitle').value = '';
        if (quill) quill.setText('');
      }
    };

    // ê²Œì‹œê¸€ ë“±ë¡
    window.submitPost = async function() {
      if (!currentUser) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        return;
      }

      const title = document.getElementById('postTitle').value.trim();
      const content = quill.root.innerHTML.trim();
      const textContent = quill.getText().trim();

      if (!title || !textContent) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      try {
        const { error } = await supabase
          .from('board_posts')
          .insert({
            game_id: gameId,
            game_slug: gameSlug,
            user_id: currentUser.id,
            title: title,
            content: content
          });

        if (error) throw error;

        alert('ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
        toggleWriteForm();
        loadPosts();
      } catch (err) {
        console.error('Error creating post:', err);
        alert('ê²Œì‹œê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + err.message);
      }
    };

    // ê²Œì‹œê¸€ ìƒì„¸ë³´ê¸°
    window.viewPost = function(postId) {
      location.href = `/board_post.html?id=${postId}`;
    };

    // ì´ˆê¸° ë¡œë“œ
    checkAuthStatus();
    loadPosts();
  </script>
</body>
</html>