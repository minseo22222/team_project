<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê²Œì„ ìƒì„¸ - ê°“ê²œíŒë…ê¸°</title>
  <link rel="stylesheet" href="./css/style_game.css">
  <link rel="stylesheet" href="./css/style_review.css">
</head>

<body>
  <div id="header"></div>

  <script type="module">
    // [ì¶”ê°€ëœ ë¶€ë¶„ 1] Supabase ê°€ì ¸ì˜¤ê¸°
    import supabase from './scripts/supabase.js';

    // [ì¶”ê°€ëœ ë¶€ë¶„ 2] ë¡œê·¸ì•„ì›ƒ ê°ì§€ ë¦¬ìŠ¤ë„ˆ
    // í—¤ë”ì—ì„œ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ì´ ì½”ë“œê°€ ê°ì§€í•˜ê³  í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•©ë‹ˆë‹¤.
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT') {
        window.location.reload();
      }
    });

    // ê¸°ì¡´ í—¤ë” ë¡œë“œ ë¡œì§
    fetch('components/header.html')
      .then(res => res.text())
      .then(html => {
        document.getElementById('header').innerHTML = html;
        const redirectURL = document.getElementById('redirect');
        if (redirectURL) { // ì—ëŸ¬ ë°©ì§€ë¥¼ ìœ„í•œ if ì²´í¬ ì¶”ê°€
            redirectURL.textContent = window.location.href; 
        }
        
        // ì™¸ë¶€ JS ì¶”ê°€ ì‹¤í–‰
        const script = document.createElement('script');
        script.type = 'module';
        script.src = 'scripts/header_user.js';
        document.body.appendChild(script);
      });
  </script>
  <main>
    <div class="loading" id="loading">
      ê²Œì„ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...
    </div>

    <div id="gameContent" style="display: none;"></div>

    <div class="error" id="error" style="display: none;">
      <h2>âš ï¸ ê²Œì„ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</h2>
      <p>ìš”ì²­í•˜ì‹  ê²Œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
      <a href="/home.html">â† í™ˆìœ¼ë¡œ ëŒì•„ê°€ê¸°</a>
    </div>
  
  <!--/main-->
  
  <script type="module" src="./scripts/game.js"></script>

  <section class="spec-check-section">
    <h2>ğŸ–¥ï¸ ë‚´ ì»´í“¨í„°ë¡œ ì‹¤í–‰ ê°€ëŠ¥í• ê¹Œ?</h2>
    
    <div class="spec-container">
  
      <div class="spec-item">
        <h3>1. CPU (í”„ë¡œì„¸ì„œ)</h3>
        <div class="search-box">
          <input type="text" id="cpuInput" placeholder="ì˜ˆ: 5600x, i5-12400">
          <button onclick="searchPart('cpu')" class="spec-btn">ê²€ìƒ‰</button>
        </div>
        <div id="cpuList" class="result-list"></div>
        <div id="cpuSelectedText" class="selected-text">ì„ íƒëœ ë¶€í’ˆ ì—†ìŒ</div>
        
        <div id="cpuResult" style="margin-top:10px;"></div>
        <input type="hidden" id="myCpuName" value="">
        <input type="hidden" id="myCpuScore" value="0">
      </div>

      <div class="spec-item">
        <h3>2. GPU (ê·¸ë˜í”½ì¹´ë“œ)</h3>
        <div class="search-box">
          <input type="text" id="gpuInput" placeholder="ì˜ˆ: RTX 3060, GTX 1060">
          <button onclick="searchPart('gpu')" class="spec-btn">ê²€ìƒ‰</button>
        </div>
        <div id="gpuList" class="result-list"></div>
        <div id="gpuSelectedText" class="selected-text">ì„ íƒëœ ë¶€í’ˆ ì—†ìŒ</div>

        <div id="gpuResult" style="margin-top:10px;"></div>
        <input type="hidden" id="myGpuName" value="">
        <input type="hidden" id="myGpuScore" value="0">
      </div>

    </div>

    <div class="spec-result-container">
      <h3>3. êµ¬ë™ ì—¬ë¶€ í™•ì¸</h3>
      <button onclick="checkCanRun()" class="check-btn">ğŸ® ì‹¤í–‰ ê°€ëŠ¥í•œì§€ í™•ì¸í•˜ê¸°</button>
      <div id="finalResult" class="final-result"></div>
    </div>
    </section>
  
  <script type="module">
  // supabase import ì¶”ê°€
  import supabase from './scripts/supabase.js';

  // ë¶€í’ˆ ê²€ìƒ‰ í•¨ìˆ˜
  async function searchPart(type) {
    const inputId = type + 'Input';
    const listId = type + 'List';
    const tableName = type + '_tb';

    const keyword = document.getElementById(inputId).value;
    const listDiv = document.getElementById(listId);

    if(!keyword) { 
      alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”!"); 
      return; 
    }

    listDiv.style.display = 'block';
    listDiv.innerHTML = '<div class="result-item">ê²€ìƒ‰ ì¤‘...</div>';

    try {
      const { data, error } = await supabase
        .from(tableName)
        .select('*')
        .ilike('model_name', '%' + keyword + '%')
        .order('score', { ascending: false })
        .limit(10);

      if (error) {
        console.error("Supabase Error:", error);
        listDiv.innerHTML = '<div class="result-item">ì˜¤ë¥˜: ' + error.message + '</div>';
        return;
      }

      listDiv.innerHTML = '';

      if (!data || data.length === 0) {
        listDiv.innerHTML = '<div class="result-item">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        return;
      }

      data.forEach(item => {
        const div = document.createElement('div');
        div.className = 'result-item';
        div.innerHTML = `<strong>${item.model_name}</strong><br><span style="font-size:0.85em; color:#64748b;">ì ìˆ˜: ${item.score}</span>`;
        
        div.onclick = function() {
          selectPart(type, item.model_name, item.score);
        };
        listDiv.appendChild(div);
      });
    } catch (err) {
      console.error('ê²€ìƒ‰ ì˜¤ë¥˜:', err);
      listDiv.innerHTML = '<div class="result-item">ê²€ìƒ‰ ì‹¤íŒ¨: ' + err.message + '</div>';
    }
  }

  // ë¶€í’ˆ ì„ íƒ í•¨ìˆ˜
  // [ìˆ˜ì •ë¨] ë¶€í’ˆ ì„ íƒ í•¨ìˆ˜ (ì´ë¦„ë„ ê°™ì´ ì €ì¥!)
function selectPart(type, name, score) {
  // 1. í™”ë©´ì— ì„ íƒëœ ì´ë¦„ í‘œì‹œ
  document.getElementById(type + 'SelectedText').innerText = `âœ… ì„ íƒë¨: ${name}`;
  
  // 2. ì ìˆ˜ ì €ì¥ (ê¸°ì¡´ ê¸°ëŠ¥)
  const scoreId = 'my' + type.charAt(0).toUpperCase() + type.slice(1) + 'Score';
  document.getElementById(scoreId).value = score;
  
  // 3. â˜… ì´ë¦„ ì €ì¥ (ìƒˆë¡œ ì¶”ê°€ëœ ê¸°ëŠ¥)
  const nameId = 'my' + type.charAt(0).toUpperCase() + type.slice(1) + 'Name';
  document.getElementById(nameId).value = name;
  
  // 4. ëª©ë¡ ë‹«ê¸°
  document.getElementById(type + 'List').style.display = 'none';
}

  // ìµœì¢… ë¹„êµ í•¨ìˆ˜
  // [ìˆ˜ì •ë¨] ìµœì¢… ë¹„êµ í•¨ìˆ˜ (ìµœì†Œ/ê¶Œì¥ ê°ê° ë¹„êµ ê¸°ëŠ¥ ì¶”ê°€)
  // [ìˆ˜ì •ë¨] ìµœì¢… ë¹„êµ í•¨ìˆ˜ (ë¸Œëœë“œ ì¸ì‹ ëŠ¥ë ¥ ê°•í™” ë²„ì „)
  async function checkCanRun() {
    const myCpuScore = parseInt(document.getElementById('myCpuScore').value) || 0;
    const myGpuScore = parseInt(document.getElementById('myGpuScore').value) || 0;
    const myCpuName = document.getElementById('myCpuName').value || "";
    const myGpuName = document.getElementById('myGpuName').value || "";

    const cpuResDiv = document.getElementById('cpuResult');
    const gpuResDiv = document.getElementById('gpuResult');
    const finalResDiv = document.getElementById('finalResult');

    const params = new URLSearchParams(window.location.search);
    const gameSlug = params.get('id');

    if (myCpuScore === 0 || myGpuScore === 0) {
      alert("ë¨¼ì € CPUì™€ ê·¸ë˜í”½ì¹´ë“œë¥¼ ëª¨ë‘ ê²€ìƒ‰í•´ì„œ ì„ íƒí•´ì£¼ì„¸ìš”!");
      return;
    }

    cpuResDiv.innerHTML = "<small>ë¶„ì„ ì¤‘...</small>";
    gpuResDiv.innerHTML = "<small>ë¶„ì„ ì¤‘...</small>";
    finalResDiv.innerHTML = "ë°ì´í„° ë¶„ì„ ì¤‘...";

    try {
      const { data: gameData, error: gameError } = await supabase
        .from('Games').select('steam_app_id').eq('slug', gameSlug).single();

      if (gameError || !gameData?.steam_app_id) {
        finalResDiv.innerHTML = "<span class='spec-fail'>ê²Œì„ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</span>"; return;
      }

      const { data, error } = await supabase
        .from('game_score_tb').select('*').eq('steam_app_id', gameData.steam_app_id).single();

      if (error || !data) {
        finalResDiv.innerHTML = "<span class='spec-fail'>ì‚¬ì–‘ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</span>"; return;
      }

      // â˜… [í•µì‹¬ ë³€ê²½] ë¸Œëœë“œë¥¼ ë” ë˜‘ë˜‘í•˜ê²Œ ì°¾ëŠ” í•¨ìˆ˜
      const getMatchingPart = (jsonObj, myModelName) => {
        if (!jsonObj || Object.keys(jsonObj).length === 0) return { score: 0, name: "ì •ë³´ ì—†ìŒ" };
        
        // 1. ë‚´ ë¶€í’ˆì˜ ë¸Œëœë“œ(íŒŒë²Œ) í™•ì¸
        let myBrandGroup = [];
        const upperName = myModelName.toUpperCase();
        
        if (upperName.includes("INTEL") || upperName.includes("ARC")) {
          myBrandGroup = ["INTEL", "ARC"];
        } else if (upperName.includes("AMD") || upperName.includes("RYZEN") || upperName.includes("RADEON")) {
          myBrandGroup = ["AMD", "RYZEN", "RADEON"];
        } else if (upperName.includes("NVIDIA") || upperName.includes("GEFORCE") || upperName.includes("RTX") || upperName.includes("GTX")) {
          myBrandGroup = ["NVIDIA", "GEFORCE"];
        }

        let bestMatch = { score: Infinity, name: "" };
        let fallbackMatch = { score: Infinity, name: "" };

        // 2. ì‚¬ì–‘ ëª©ë¡ ë’¤ì§€ê¸°
        for (const [key, score] of Object.entries(jsonObj)) {
          const upperKey = key.toUpperCase();
          
          // (Fallback) ì¼ë‹¨ ì „ì²´ ì¤‘ì—ì„œ ì ìˆ˜ê°€ ê°€ì¥ ë‚®ì€ ê²ƒë„ ê¸°ì–µí•´ë‘  (í˜¹ì‹œ ë§ëŠ” ë¸Œëœë“œê°€ ì—†ì„ ë•Œ ëŒ€ë¹„)
          if (score < fallbackMatch.score) {
            fallbackMatch = { score, name: key };
          }

          // (Brand Match) ë‚´ ë¸Œëœë“œ í‚¤ì›Œë“œ ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ì–´ ìˆìœ¼ë©´ ê°™ì€ í¸!
          // ì˜ˆ: ë‚´ê»˜ NVIDIAì¸ë°, í‚¤ê°’ì— "GEFORCE"ê°€ ìˆìœ¼ë©´ í•©ê²©
          let isBrandMatch = false;
          if (myBrandGroup.length > 0) {
             // ë°°ì—´ ì•ˆì— ìˆëŠ” ë‹¨ì–´(NVIDIA, GEFORCE ë“±) ì¤‘ í•˜ë‚˜ë¼ë„ í¬í•¨ë˜ë©´ true
             if (myBrandGroup.some(brand => upperKey.includes(brand))) {
               isBrandMatch = true;
             }
          }

          if (isBrandMatch) {
            // ê°™ì€ ë¸Œëœë“œ ì¤‘ì—ì„œ ì ìˆ˜ê°€ ê°€ì¥ ë‚®ì€ ê±¸(ê°€ì¥ ë§Œë§Œí•œ ê¸°ì¤€) ì„ íƒ
            if (score < bestMatch.score) {
              bestMatch = { score, name: key };
            }
          }
        }
        
        // ë§ëŠ” ë¸Œëœë“œ ì°¾ì•˜ìœ¼ë©´ ê·¸ê±° ì£¼ê³ , ëª» ì°¾ì•˜ìœ¼ë©´ ê·¸ëƒ¥ ì œì¼ ë‚®ì€ ê±° ì¤Œ
        return (bestMatch.score !== Infinity) ? bestMatch : fallbackMatch;
      };

      const minCpu = getMatchingPart(data.min_cpu_score, myCpuName);
      const recCpu = getMatchingPart(data.rec_cpu_score, myCpuName);
      
      const minGpu = getMatchingPart(data.min_gpu_score, myGpuName);
      const recGpu = getMatchingPart(data.rec_gpu_score, myGpuName);

      const createResultBox = (label, myScore, target) => {
        const isPass = myScore >= target.score;
        return `
          <div style="margin-top:6px; padding:8px; border-radius:6px; background:${isPass ? '#ecfdf5' : '#fef2f2'}; border:1px solid ${isPass ? '#10b981' : '#ef4444'};">
            <div style="display:flex; justify-content:space-between; font-size:13px;">
              <strong>${label}</strong>
              <strong style="color:${isPass ? '#059669' : '#dc2626'}">${isPass ? 'âœ… í•©ê²©' : 'âš ï¸ ë¶€ì¡±'}</strong>
            </div>
            <div style="font-size:12px; color:#555; margin-top:2px;">
              ë‚´ ì ìˆ˜: <b>${myScore.toLocaleString()}</b> / í•„ìš”: ${target.score.toLocaleString()}
            </div>
            <div style="font-size:11px; color:#888;">(ê¸°ì¤€: ${target.name})</div>
          </div>
        `;
      };

      cpuResDiv.innerHTML = `
        ${createResultBox("ìµœì†Œ ì‚¬ì–‘", myCpuScore, minCpu)}
        ${createResultBox("ê¶Œì¥ ì‚¬ì–‘", myCpuScore, recCpu)}
      `;

      gpuResDiv.innerHTML = `
        ${createResultBox("ìµœì†Œ ì‚¬ì–‘", myGpuScore, minGpu)}
        ${createResultBox("ê¶Œì¥ ì‚¬ì–‘", myGpuScore, recGpu)}
      `;

      const minPass = (myCpuScore >= minCpu.score) && (myGpuScore >= minGpu.score);
      const recPass = (myCpuScore >= recCpu.score) && (myGpuScore >= recGpu.score);

      if (recPass) {
        finalResDiv.innerHTML = `<h2 class="spec-pass" style="margin:0;">ğŸš€ ì™„ë²½ êµ¬ë™ ê°€ëŠ¥!</h2><p>ê¶Œì¥ ì‚¬ì–‘ì„ ëª¨ë‘ ì¶©ì¡±í•©ë‹ˆë‹¤.</p>`;
      } else if (minPass) {
        finalResDiv.innerHTML = `<h2 class="spec-pass" style="margin:0; color:#d97706;">ğŸ‘Œ í”Œë ˆì´ ê°€ëŠ¥</h2><p>ìµœì†Œ ì‚¬ì–‘ì€ í†µê³¼í–ˆìŠµë‹ˆë‹¤.</p>`;
      } else {
        finalResDiv.innerHTML = `<h2 class="spec-fail" style="margin:0;">ğŸ˜¢ ì—…ê·¸ë ˆì´ë“œ í•„ìš”</h2><p>ì‚¬ì–‘ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.</p>`;
      }

    } catch (err) {
      console.error(err);
      finalResDiv.innerHTML = "ì˜¤ë¥˜ ë°œìƒ: " + err.message;
    }
  }

  // ì „ì—­ í•¨ìˆ˜ë¡œ ë“±ë¡ (HTML onclickì—ì„œ ì‚¬ìš©)
  window.searchPart = searchPart;
  window.checkCanRun = checkCanRun;
</script>

  <section class="reviews-section" id="reviews">
    <h2>í‰ê°€ ì‘ì„±</h2>

    <form class="review-composer" action="" method="post">
      <div class="row">
        <strong>ë³„ì :</strong>
        <div class="rating" aria-label="ë³„ì  ì„ íƒ">
          <input type="radio" id="star5" name="rating" value="5" >
          <label for="star5" title="5ì "></label>

          <input type="radio" id="star4" name="rating" value="4">
          <label for="star4" title="4ì "></label>

          <input type="radio" id="star3" name="rating" value="3">
          <label for="star3" title="3ì "></label>

          <input type="radio" id="star2" name="rating" value="2">
          <label for="star2" title="2ì "></label>

          <input type="radio" id="star1" name="rating" value="1">
          <label for="star1" title="1ì "></label>
        </div>
      </div>
      <div class="row recommend-row">
        <strong></strong>
        <div class="recommend" role="radiogroup" aria-label="ì¶”ì²œ ì—¬ë¶€">
          <input type="radio" id="rec-yes" name="is_recommended" value="1" >
          <label for="rec-yes" class="chip yes">ì¶”ì²œ</label>

          <input type="radio" id="rec-no" name="is_recommended" value="0">
          <label for="rec-no" class="chip no">ë¹„ì¶”ì²œ</label>
        </div>
      </div>

      <textarea name="comment" placeholder="ê²Œì„ì— ëŒ€í•œ í‰ê°€ë¥¼ ì ì–´ì£¼ì„¸ìš”."></textarea>

      <div class="review-actions">
        <input type="reset" value="ë‹¤ì‹œì“°ê¸°" class="btn">
        <input type="submit" value="í‰ê°€" class="btn">
      </div>
    </form>
  </section>

  <section class="reviews-view" id="reviews-view">
    <div class="reviews-toolbar">
      <button type="button" class="sort-btn active" data-sort="time">ì‹œê°„ìˆœ â–¾</button>
      <button type="button" class="sort-btn" data-sort="reco">ì¶”ì²œìˆœ â–¾</button>
    </div>

    <div id="review-list" class="review-list" aria-live="polite"></div>

  <button id="load-more" class="loadmore-btn" type="button">ì¶”ê°€ ë³´ê¸°</button>
</section>
</main>
<script type="module" src="./scripts/review.js"></script>
</body>
</html>